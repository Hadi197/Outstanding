<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outstanding Wilayah 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        accent: {
                            500: '#8b5cf6',
                            600: '#7c3aed'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Chart specific styles for Chart.js */
        .chart-wrapper {
            width: 100%;
            height: 300px;
            margin: 0 auto;
        }
        
        #barChart {
            width: 100% !important;
            height: 300px !important;
            display: block;
        }
        
        @media (max-width: 640px) {
            .chart-wrapper, #barChart { height: 220px !important; }
        }

        /* Hide chart title */
        #chartTitle { display: none !important; }

        /* Hide filter labels */
        label[for="pelabuhanFilter"],
        label[for="yearFilter"] {
            display: none !important;
        }

        /* Tab styling */
        .tab-button {
            position: relative;
        }
        
        .tab-button:hover {
            background-color: #f9fafb;
        }
        
        .tab-button.active {
            background-color: #eff6ff !important;
            color: #2563eb !important;
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card decorative circle */
        .stat-card .card-circle {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            right: -15px;
            bottom: -15px;
            opacity: 0.15;
            filter: blur(6px);
            pointer-events: none;
        }

        /* Card text styling */
        .stat-title {
            font-size: clamp(0.7rem, 1vw, 0.9rem);
            font-weight: 700;
            line-height: 1.2;
            word-break: break-word;
        }
        
        .stat-value {
            font-size: clamp(0.8rem, 1.8vw, 1.2rem);
            font-weight: 900;
            line-height: 1;
        }

        .pkk-manual {
            font-size: 0.75rem;
            font-weight: 800;
            margin-top: 6px;
            color: rgba(255,255,255,0.95);
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .pelayaran-stats {
            font-size: 0.6rem;
            font-weight: 600;
            line-height: 1.1;
            margin-top: 4px;
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <!-- Modern Header with Tailwind -->
    <header class="relative w-full bg-gradient-to-br from-blue-600 via-purple-600 to-pink-500 py-8 px-4 mb-8 overflow-hidden">
        <!-- Background decoration -->
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
        <div class="absolute top-0 left-0 w-64 h-64 bg-purple-400/20 rounded-full -translate-x-32 -translate-y-32 blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-pink-400/20 rounded-full translate-x-32 translate-y-32 blur-3xl"></div>
        
        <!-- Header content -->
        <div class="relative z-10 text-center">
            <h1 class="text-xl md:text-3xl lg:text-4xl font-black text-white mb-2 tracking-tight">
                OUTSTANDING WILAYAH 3
            </h1>
            <p class="text-blue-100 text-xs md:text-sm font-medium">Dashboard Monitoring dan Analisis Data</p>
        </div>
        
        <!-- Decorative elements -->
        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400"></div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="flex border-b border-gray-200">
                <button id="dashboardTab" class="tab-button active px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 bg-blue-50 text-blue-600 border-b-2 border-blue-600">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Dashboard
                </button>
                <button id="tabelTab" class="tab-button px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18M8 18h8M8 6h8"></path>
                    </svg>
                    Tabel
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab Content -->
    <div id="dashboardContent" class="tab-content">
        <!-- Stats Cards Section -->
    <div class="max-w-7xl mx-auto px-4 mb-8">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-100 p-6">
            <div id="pelabuhanCardsContainer">
                <!-- Regional groups will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <section class="max-w-7xl mx-auto px-4 mb-8">
        <!-- Chart Container -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <!-- Chart Header -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Data Visualization</h3>
                            <p class="text-sm text-gray-600">Analisis Keberangkatan Bulanan</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-1 text-xs text-gray-500">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span>Live Data</span>
                        </div>
                        <button class="p-1.5 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chart Content -->
            <div class="p-6">
                <h5 id="chartTitle" class="hidden">Departures per Month</h5>
                
                <!-- Chart Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 text-xs font-medium uppercase tracking-wide">Total Data</p>
                                <p id="totalDataCount" class="text-2xl font-bold text-blue-900">-</p>
                            </div>
                            <div class="p-2 bg-blue-200 rounded-lg">
                                <svg class="w-4 h-4 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 text-xs font-medium uppercase tracking-wide">Dalam Negeri</p>
                                <p id="dnCount" class="text-2xl font-bold text-green-900">-</p>
                            </div>
                            <div class="p-2 bg-green-200 rounded-lg">
                                <svg class="w-4 h-4 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-600 text-xs font-medium uppercase tracking-wide">Luar Negeri</p>
                                <p id="lnCount" class="text-2xl font-bold text-purple-900">-</p>
                            </div>
                            <div class="p-2 bg-purple-200 rounded-lg">
                                <svg class="w-4 h-4 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-600 text-xs font-medium uppercase tracking-wide">PKK Manual</p>
                                <p id="manualCount" class="text-2xl font-bold text-orange-900">-</p>
                            </div>
                            <div class="p-2 bg-orange-200 rounded-lg">
                                <svg class="w-4 h-4 text-orange-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Container -->
                <div class="chart-wrapper bg-gray-50 rounded-xl border border-gray-200 p-4">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </section>
    </div>

    <!-- Tabel Tab Content -->
    <div id="tabelContent" class="tab-content hidden">
        <!-- Filters and Controls -->
    <div class="max-w-7xl mx-auto px-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <!-- Filters -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <div>
                        <label for="pelabuhanFilter" class="hidden">Filter by Pelabuhan:</label>
                        <select id="pelabuhanFilter" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 hover:bg-gray-100 min-w-[160px]">
                            <option value="ALL">Semua Pelabuhan</option>
                        </select>
                    </div>
                    <div>
                        <label for="yearFilter" class="hidden">Filter by Tahun:</label>
                        <select id="yearFilter" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 hover:bg-gray-100 min-w-[120px]">
                            <option value="ALL">Semua Tahun</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button id="downloadGabungBtn" type="button" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download Data
                    </button>
                    <button id="clearFilterBtn" type="button" class="px-6 py-2 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="max-w-7xl mx-auto px-4 mb-8" id="tableContainer">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gradient-to-r from-gray-800 to-gray-900 text-white">
                        <tr id="table-header" class="text-center">
                            <!-- Table headers will be dynamically inserted here -->
                        </tr>
                        <tr id="table-filter-row" class="bg-gray-100">
                            <!-- Filter inputs will be dynamically inserted here -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200">
                        <!-- Table rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Tab functionality
        function initTabs() {
            const dashboardTab = document.getElementById('dashboardTab');
            const tabelTab = document.getElementById('tabelTab');
            const dashboardContent = document.getElementById('dashboardContent');
            const tabelContent = document.getElementById('tabelContent');

            function switchTab(activeTab, inactiveTab, activeContent, inactiveContent) {
                // Update tab appearance
                activeTab.classList.add('active', 'bg-blue-50', 'text-blue-600', 'border-b-2', 'border-blue-600');
                activeTab.classList.remove('text-gray-600');
                
                inactiveTab.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-b-2', 'border-blue-600');
                inactiveTab.classList.add('text-gray-600');
                
                // Update content visibility
                activeContent.classList.remove('hidden');
                inactiveContent.classList.add('hidden');
            }

            dashboardTab.addEventListener('click', () => {
                switchTab(dashboardTab, tabelTab, dashboardContent, tabelContent);
            });

            tabelTab.addEventListener('click', () => {
                switchTab(tabelTab, dashboardTab, tabelContent, dashboardContent);
            });
        }

        // Initialize tabs when page loads
        document.addEventListener('DOMContentLoaded', initTabs);
        async function fetchCSV(filePath) {
            try {
                const response = await fetch(filePath);
                const data = await response.text();
                return data;
            } catch (error) {
                console.error("Failed to fetch CSV file:", error);
                return null;
            }
        }

        function parseCSV(csvText) {
            const rows = csvText.split("\n").filter(row => row.trim() !== "");
            const headers = rows[0].split(",");
            const data = rows.slice(1).map(row => {
                const values = [];
                let current = "";
                let insideQuotes = false;

                for (let char of row) {
                    if (char === '"' && insideQuotes) {
                        insideQuotes = false;
                    } else if (char === '"' && !insideQuotes) {
                        insideQuotes = true;
                    } else if (char === "," && !insideQuotes) {
                        values.push(current.trim());
                        current = "";
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                return headers.reduce((acc, header, index) => {
                    acc[header] = values[index] ? values[index].replace(/^"|"$/g, "") : "";
                    return acc;
                }, {});
            });
            return { headers, data };
        }

        // Mapping label header tampilan -> field asli
        const HEADER_MAP = {
            no_pkk: "PKK",
            no_pkk_inaportnet: "PKK INAPORTNET",
            nomor_spb: "SPB",
            no_pkk_spb: "NO PKK",          // <-- added
            company_name: "AGEN",          // <-- added
            departure_date: "KEBERANGKATAN", // <-- added
            name_process_code: "STATUS",
            gt: "GRT",
            loa: "LOA",
            waktu_tolak: "TGL/JAM",
            vessel_name: "NAMA KAPAL",
            vessel_name_spb: "NAMA KAPAL", // mapping baru
            NO: "NO",
            PELABUHAN: "PELABUHAN",
            PELAYARAN: "PELAYARAN",
            zone: "ZONA",
        };

        function populateTable(headers, data) {
        const tableHeader = document.getElementById("table-header");
        const tableBody = document.getElementById("table-body");
        const tableFilterRow = document.getElementById("table-filter-row");

        // Clear existing table content
        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";
        tableFilterRow.innerHTML = "";

        // Kolom yang ingin disembunyikan
        const hiddenCols = new Set([
            "name_branch", "no_pkk_wasop", "waktu_tolak",
            "zone_lhgk", "no_pkk_lhgk", "PKK", "no_pkk",
            "status_nota",
            "nomor_pkk",           // hide kolom nomor_pkk
            "vessel_name_wasop"    // hide kolom vessel_name_wasop
        ]);
        const updatedHeaders = [
            "NO",
            ...headers.filter(h => !hiddenCols.has(h)),
            "PELABUHAN",
            "PELAYARAN"
        ];

        // Populate table headers (pakai label tampilan)
        updatedHeaders.forEach(header => {
            const th = document.createElement("th");
            th.className = "px-4 py-3 text-xs font-semibold uppercase tracking-wider";
            th.textContent = HEADER_MAP[header] || header;
            tableHeader.appendChild(th);
        });

        // --- Filter row ---
        updatedHeaders.forEach(header => {
            const th = document.createElement("th");
            th.className = "px-4 py-2";
            if (header === "NO") {
                th.innerHTML = "";
            } else {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500";
                input.style.minWidth = "60px";
                input.placeholder = "Filter";
                input.addEventListener("input", function() {
                    filterTableByHeader();
                });
                th.appendChild(input);
            }
            tableFilterRow.appendChild(th);
        });

        // Populate table rows (tetap pakai key asli untuk ambil data)
        data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 transition-colors duration-150";
            updatedHeaders.forEach(header => {
                const td = document.createElement("td");
                td.className = "px-4 py-3 text-xs whitespace-nowrap";
                if (header === "NO") {
                    td.textContent = index + 1;
                    td.className += " font-medium text-gray-900";
                } else if (header === "PELABUHAN") {
                    td.textContent = row["name_branch"] || "";
                } else if (header === "PELAYARAN") {
                    if (row["no_pkk_inaportnet"]?.includes("PKK.DN")) {
                        td.textContent = "Dalam Negeri";
                        td.className += " text-green-600 font-medium";
                    } else if (row["no_pkk_inaportnet"]?.includes("PKK.LN")) {
                        td.textContent = "Luar Negeri";
                        td.className += " text-blue-600 font-medium";
                    } else {
                        td.textContent = "";
                    }
                } else {
                    td.textContent = row[header] || "";
                }
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    // Filter table by filter row input
    function filterTableByHeader() {
        const tableBody = document.getElementById("table-body");
        const tableFilterRow = document.getElementById("table-filter-row");
        const filterInputs = Array.from(tableFilterRow.querySelectorAll("input"));
        const trs = Array.from(tableBody.querySelectorAll("tr"));

        trs.forEach(tr => {
            let show = true;
            filterInputs.forEach((input, idx) => {
                const val = input.value.trim().toLowerCase();
                if (val) {
                    const td = tr.children[idx + 1]; // skip NO column
                    if (td && !td.textContent.toLowerCase().includes(val)) {
                        show = false;
                    }
                }
            });
            tr.style.display = show ? "" : "none";
        });
    }

        function aggregateByMonth(data) {
            const monthCounts = {};
            data.forEach(row => {
                const departureDate = row["departure_date"];
                if (!departureDate) return;

                const monthKey = departureDate.slice(0, 7); // Extract YYYY-MM format
                const year = departureDate.slice(0, 4); // Extract year
                
                // Only include data from 2024 and 2025
                if (year === "2024" || year === "2025") {
                    monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                }
            });

            const labels = Object.keys(monthCounts).sort();
            const values = labels.map(label => monthCounts[label]);
            return { labels, values };
        }

        let selectedMonth = null;

        function buildBarChart(ctx, labels, values) {
	// Modern gradient colors inspired by popular dashboard templates
	const modernColors = [
		{ primary: "#3B82F6", secondary: "#60A5FA", bg: "rgba(59, 130, 246, 0.1)" },
		{ primary: "#10B981", secondary: "#34D399", bg: "rgba(16, 185, 129, 0.1)" },
		{ primary: "#8B5CF6", secondary: "#A78BFA", bg: "rgba(139, 92, 246, 0.1)" },
		{ primary: "#F59E0B", secondary: "#FBBF24", bg: "rgba(245, 158, 11, 0.1)" },
		{ primary: "#EF4444", secondary: "#F87171", bg: "rgba(239, 68, 68, 0.1)" },
		{ primary: "#06B6D4", secondary: "#22D3EE", bg: "rgba(6, 182, 212, 0.1)" },
		{ primary: "#84CC16", secondary: "#A3E635", bg: "rgba(132, 204, 22, 0.1)" },
		{ primary: "#F97316", secondary: "#FB923C", bg: "rgba(249, 115, 22, 0.1)" },
		{ primary: "#EC4899", secondary: "#F472B6", bg: "rgba(236, 72, 153, 0.1)" }
	];

	const chart = new Chart(ctx, {
		type: "bar",
		data: {
			labels: labels,
			datasets: [{
				label: "Jumlah Keberangkatan",
				data: values,
				backgroundColor: function(context) {
					const chart = context.chart;
					const {ctx, chartArea} = chart;
					if (!chartArea) return modernColors[0].primary;
					
					const colorSet = modernColors[context.dataIndex % modernColors.length];
					const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
					gradient.addColorStop(0, colorSet.primary);
					gradient.addColorStop(1, colorSet.secondary);
					return gradient;
				},
				borderColor: function(context) {
					return modernColors[context.dataIndex % modernColors.length].primary;
				},
				borderWidth: 2,
				borderRadius: 8,
				borderSkipped: false,
				hoverBackgroundColor: function(context) {
					return modernColors[context.dataIndex % modernColors.length].primary;
				},
				hoverBorderColor: "#FFFFFF",
				hoverBorderWidth: 3,
				barPercentage: 0.7,
				categoryPercentage: 0.8,
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			interaction: {
				intersect: false,
				mode: 'index'
			},
			animation: {
				duration: 1500,
				easing: 'easeInOutQuart'
			},
			layout: { 
				padding: { 
					top: 20, 
					bottom: 20, 
					left: 20, 
					right: 20 
				} 
			},
			plugins: {
				legend: { 
					display: true,
					position: 'top',
					labels: {
						color: '#374151',
						font: {
							size: 12,
							weight: '600'
						},
						padding: 15,
						usePointStyle: true,
						pointStyle: 'rectRounded'
					}
				},
				title: {
					display: true,
					text: 'Grafik Keberangkatan Bulanan',
					color: '#1F2937',
					font: {
						size: 14,
						weight: 'bold'
					},
					padding: {
						bottom: 20
					}
				},
				tooltip: {
					backgroundColor: 'rgba(0, 0, 0, 0.8)',
					titleColor: '#FFFFFF',
					bodyColor: '#FFFFFF',
					cornerRadius: 8,
					padding: 12,
					displayColors: true,
					callbacks: {
						title: function(context) {
							return `Bulan: ${context[0].label}`;
						},
						label: function(context) {
							return `Keberangkatan: ${context.parsed.y.toLocaleString()}`;
						}
					}
				},
				datalabels: {
					display: true,
					anchor: 'end',
					align: 'top',
					offset: 6,
					backgroundColor: function(context) {
						return modernColors[context.dataIndex % modernColors.length].primary;
					},
					borderColor: '#FFFFFF',
					borderWidth: 2,
					borderRadius: 8,
					color: '#FFFFFF',
					font: { 
						weight: 'bold', 
						size: 12 
					},
					padding: { 
						top: 6, 
						bottom: 6, 
						left: 8, 
						right: 8 
					},
					formatter: function(value) { 
						if (value === 0 || value === null || value === undefined) return '';
						return value.toLocaleString(); 
					}
				}
			},
			scales: {
				x: {
					grid: {
						display: false
					},
					ticks: {
						color: "#6B7280",
						font: {
							size: 12,
							weight: '500'
						},
						maxRotation: 45,
						minRotation: 45,
						padding: 10
					},
					border: {
						display: false
					}
				},
				y: {
					beginAtZero: true,
					grid: {
						color: "rgba(229, 231, 235, 0.8)",
						borderDash: [2, 4]
					},
					ticks: {
						color: "#6B7280",
						font: {
							size: 12
						},
						padding: 10,
						callback: function(value) {
							return value.toLocaleString();
						}
					},
					border: {
						display: false
					}
				}
			},
			onHover: (event, elements) => {
				event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
			},
			onClick: function(evt, elements) {
				const chart = this;
				if (elements.length) {
					const idx = elements[0].index;
					const month = chart.data.labels[idx];
					selectedMonth = month;
					filterTableByPelabuhan(globalData, document.getElementById("pelabuhanFilter").value, month);
					
					// Visual feedback for selection
					chart.update('none');
				} else {
					selectedMonth = null;
					filterTableByPelabuhan(globalData, document.getElementById("pelabuhanFilter").value);
				}
			}
		},
		plugins: [ChartDataLabels]
	});

	return chart;
}

        let globalData = [];
        let globalHeaders = [];
        let barChart;

        function populatePelabuhanFilter(data) {
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) {
                    pelabuhanKey = "name_branch";
                } else {
                    pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
                }
            }
            const pelabuhanSet = new Set(data.map(row => row[pelabuhanKey]).filter(Boolean));
            const pelabuhanFilter = document.getElementById("pelabuhanFilter");

            pelabuhanFilter.innerHTML = '<option value="ALL">Semua Pelabuhan</option>';

            pelabuhanSet.forEach(pelabuhan => {
                const option = document.createElement("option");
                option.value = pelabuhan;
                option.textContent = pelabuhan;
                pelabuhanFilter.appendChild(option);
            });
        }

        // Populate year combobox from departure_date (unique years)
        function populateYearFilter(data) {
		const years = new Set();
		data.forEach(row => {
			const d = row["departure_date"];
			if (d && d.length >= 4) years.add(d.slice(0, 4));
		});
		const yearFilter = document.getElementById("yearFilter");
		yearFilter.innerHTML = '<option value="ALL">Semua Tahun</option>';
		Array.from(years).sort().forEach(y => {
			const opt = document.createElement("option");
			opt.value = y;
			opt.textContent = y;
			yearFilter.appendChild(opt);
		});
	}

        // Unified filter: pelabuhan + year (+ optional month)
        function filterByPelabuhanAndYear() {
            const pelabuhan = document.getElementById("pelabuhanFilter").value || "ALL";
            const year = document.getElementById("yearFilter") ? document.getElementById("yearFilter").value : "ALL";
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) pelabuhanKey = "name_branch";
                else pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
            }

            let filtered = globalData.slice();

            if (pelabuhan !== "ALL") filtered = filtered.filter(r => (r[pelabuhanKey] || "") === pelabuhan);
            if (year !== "ALL") filtered = filtered.filter(r => (r["departure_date"] || "").startsWith(year));
            if (selectedMonth) filtered = filtered.filter(r => (r["departure_date"] || "").slice(0,7) === selectedMonth);

            populateTable(globalHeaders, filtered);
            updateBarChart(filtered);
        }

        function clearAllFilters() {
            // Reset combobox
            document.getElementById("pelabuhanFilter").value = "ALL";
            document.getElementById("yearFilter").value = "ALL";
            // Reset selected month
            selectedMonth = null;
            // Show all data in table and chart
            populateTable(globalHeaders, globalData);
            updateBarChart(globalData);
        }

        // Update attachPelabuhanFilterListener to use unified filter
        function attachPelabuhanFilterListener() {
            const pelabuhanFilter = document.getElementById("pelabuhanFilter");
            pelabuhanFilter.addEventListener("change", () => {
                selectedMonth = null;
                filterByPelabuhanAndYear();
            });

            // Tambahkan event listener untuk tombol clear filter
            document.getElementById("clearFilterBtn").addEventListener("click", clearAllFilters);

            // New: download gabung.csv button
            const dlGabung = document.getElementById("downloadGabungBtn");
            if (dlGabung) dlGabung.addEventListener("click", downloadGabung);
        }

        // Year filter listener
        function attachYearFilterListener() {
		const yearFilter = document.getElementById("yearFilter");
		yearFilter.addEventListener("change", () => {
			selectedMonth = null;
			filterByPelabuhanAndYear();
		});
	}

        function updateBarChart(filteredData) {
            const { labels, values } = aggregateByMonth(filteredData);
            if (!barChart) return;

            // Update statistics in chart section
            updateChartStats(filteredData);

            // Update labels and data
            barChart.data.labels = labels;
            barChart.data.datasets[0].data = values;

            // Smooth animation update
            barChart.update('active');
        }

        function updateChartStats(data) {
            const totalCount = data.length;
            const dnCount = data.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.DN")).length;
            const lnCount = data.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.LN")).length;
            const manualCount = data.filter(r => !((r["no_pkk_inaportnet"] || "").trim())).length;

            // Update the stat cards in chart section
            const totalEl = document.getElementById("totalDataCount");
            const dnEl = document.getElementById("dnCount");
            const lnEl = document.getElementById("lnCount");
            const manualEl = document.getElementById("manualCount");

            if (totalEl) totalEl.textContent = totalCount.toLocaleString();
            if (dnEl) dnEl.textContent = dnCount.toLocaleString();
            if (lnEl) lnEl.textContent = lnCount.toLocaleString();
            if (manualEl) manualEl.textContent = manualCount.toLocaleString();
        }

        /* Updated renderPelabuhanCards: Group by regions (Kalimantan, Jawa, Bali Nusatenggara) */
function renderPelabuhanCards(data) {
    // Definisi mapping region berdasarkan nama pelabuhan/cabang
    const regionMapping = {
        'Kalimantan': {
            keywords: ['kalimantan', 'pontianak', 'banjarmasin', 'samarinda', 'balikpapan', 'ketapang', 'sampit', 'palangkaraya', 'tanjung selor', 'tarakan', 'kotabaru', 'mekar putih', 'sts kotabaru', 'zona batulicin', 'zona satui', 'bunati', 'zona kumai', 'batulicin', 'satui', 'kumai', 'celukan bawang', 'mekarputih', 'bumiharjo', 'bagendang'],
            color: {bg: "linear-gradient(135deg, #a7f3d0, #6ee7b7, #34d399)", circle: "rgba(255,255,255,0.15)"}, // Soft emerald gradient
            icon: '🌳'
        },
        'Jawa': {
            keywords: ['jakarta', 'surabaya', 'semarang', 'cirebon', 'tanjung priok', 'tanjung perak', 'cilacap', 'probolinggo', 'jepara', 'pekalongan', 'banten', 'merak', 'tanjung wangi', 'tanjung intan', 'tanjung emas', 'zona tanjung wangi'],
            color: {bg: "linear-gradient(135deg, #bfdbfe, #93c5fd, #60a5fa)", circle: "rgba(255,255,255,0.15)"}, // Soft blue gradient
            icon: '🏙️'
        },
        'Bali Nusatenggara': {
            keywords: ['bali', 'lombok', 'sumbawa', 'flores', 'kupang', 'denpasar', 'mataram', 'ende', 'waingapu', 'labuan bajo', 'benoa', 'zona lembar', 'lembar'],
            color: {bg: "linear-gradient(135deg, #fce7f3, #fbcfe8, #f9a8d4)", circle: "rgba(255,255,255,0.15)"}, // Soft pink gradient
            icon: '🏝️'
        }
    };

    // Fungsi untuk menentukan region berdasarkan nama
    function getRegion(name) {
        const nameLower = name.toLowerCase();
        for (const [region, config] of Object.entries(regionMapping)) {
            if (config.keywords.some(keyword => nameLower.includes(keyword))) {
                return region;
            }
        }
        return 'Lainnya'; // Default untuk yang tidak cocok
    }

    // Gunakan kolom zone sebagai referensi utama
    let zoneKey = null;
    let branchKey = null;
    for (const h of globalHeaders) {
        if (h.toLowerCase() === "zone" || h.toLowerCase().includes("zone")) {
            zoneKey = h;
        }
        if (h.toLowerCase() === "name_branch" || h.toLowerCase().includes("name_branch")) {
            branchKey = h;
        }
    }
    if (!zoneKey) zoneKey = globalHeaders[0];
    if (!branchKey) branchKey = "name_branch";

    // Kelompokkan data berdasarkan zone/branch
    const zoneGroups = {};
    data.forEach(row => {
        let key = (row[zoneKey] || "").trim();
        if (!key && branchKey && row[branchKey]) {
            key = (row[branchKey] || "Unknown").trim();
        }
        if (!key) key = "Unknown";
        if (!zoneGroups[key]) zoneGroups[key] = [];
        zoneGroups[key].push(row);
    });

    // Kelompokkan zona berdasarkan region
    const regionGroups = {
        'Kalimantan': [],
        'Jawa': [],
        'Bali Nusatenggara': [],
        'Lainnya': []
    };

    Object.entries(zoneGroups).forEach(([zone, rows]) => {
        const region = getRegion(zone);
        regionGroups[region].push({zone, rows});
    });

    // Sort dalam setiap region berdasarkan jumlah data
    Object.keys(regionGroups).forEach(region => {
        regionGroups[region].sort((a, b) => b.rows.length - a.rows.length);
    });

    const container = document.getElementById("pelabuhanCardsContainer");
    container.innerHTML = "";

    // Render setiap region
    Object.entries(regionGroups).forEach(([regionName, zones]) => {
        if (zones.length === 0) return; // Skip empty regions

        // Create region section
        const regionSection = document.createElement("div");
        regionSection.className = "mb-8";

        // Region header
        const regionHeader = document.createElement("div");
        regionHeader.className = "flex items-center gap-3 mb-4 pb-2 border-b-2 border-gray-200";
        
        const regionIcon = document.createElement("span");
        regionIcon.className = "text-2xl";
        regionIcon.textContent = regionMapping[regionName]?.icon || '📍';
        
        const regionTitle = document.createElement("h3");
        regionTitle.className = "text-xl font-bold text-gray-800";
        regionTitle.textContent = regionName;
        
        const regionCount = document.createElement("span");
        regionCount.className = "text-sm bg-gray-100 px-3 py-1 rounded-full font-medium text-gray-600";
        const totalCount = zones.reduce((sum, {rows}) => sum + rows.length, 0);
        regionCount.textContent = `${zones.length} lokasi • ${totalCount} data`;
        
        regionHeader.appendChild(regionIcon);
        regionHeader.appendChild(regionTitle);
        regionHeader.appendChild(regionCount);
        
        // Cards grid for this region
        const cardsGrid = document.createElement("div");
        cardsGrid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4";

        // Render cards for this region
        zones.forEach(({zone, rows}, idx) => {
            const count = rows.length;
            const manualCount = rows.filter(r => !((r["no_pkk_inaportnet"] || "").trim())).length;
            let pct = 0;
            if (count > 0) pct = (manualCount / count) * 100;
            const pctText = (Math.abs(pct - Math.round(pct)) < 0.05) ? Math.round(pct).toString() : pct.toFixed(1);

            const dnCount = rows.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.DN")).length;
            const lnCount = rows.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.LN")).length;

            const card = document.createElement("div");
            card.className = "relative overflow-hidden bg-gradient-to-br p-2 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 text-gray-700 min-h-[65px] flex flex-col justify-between group border border-white/20 backdrop-blur-sm";
            
            // Use region-specific color or default colors
            const regionColor = regionMapping[regionName]?.color;
            if (regionColor) {
                card.style.background = regionColor.bg;
            } else {
                const defaultColors = [
                    {bg: "linear-gradient(135deg, #f3e8ff, #e9d5ff, #d8b4fe)"},
                    {bg: "linear-gradient(135deg, #fef3c7, #fde68a, #fcd34d)"},
                    {bg: "linear-gradient(135deg, #dbeafe, #bfdbfe, #93c5fd)"}
                ];
                card.style.background = defaultColors[idx % defaultColors.length].bg;
            }

            // Main content area with title and stats
            const contentArea = document.createElement("div");
            contentArea.className = "flex-1";

            const title = document.createElement("div");
            title.className = "stat-title font-bold text-gray-800 text-xs leading-tight truncate group-hover:text-gray-900 transition-colors mb-1";
            title.textContent = zone;
            title.title = zone;
            contentArea.appendChild(title);

            if (manualCount > 0) {
                const manualLabel = document.createElement("div");
                manualLabel.className = "pkk-manual text-gray-700 font-semibold text-xs opacity-90";
                manualLabel.textContent = `Manual: ${manualCount} (${pctText}%)`;
                contentArea.appendChild(manualLabel);
            }

            const pelayaranStats = document.createElement("div");
            pelayaranStats.className = "pelayaran-stats text-gray-600 font-medium text-xs leading-tight opacity-80";
            pelayaranStats.innerHTML = `DN: ${dnCount} | LN: ${lnCount}`;
            contentArea.appendChild(pelayaranStats);

            // Value positioned at bottom-right corner
            const value = document.createElement("div");
            value.className = "absolute bottom-2 right-2 font-black text-gray-900 text-lg md:text-xl group-hover:scale-110 transition-transform z-10";
            value.textContent = count;

            card.appendChild(contentArea);
            card.appendChild(value);

            const circle = document.createElement("div");
            circle.className = "card-circle";
            if (regionColor) {
                circle.style.background = regionColor.circle;
            }
            card.appendChild(circle);

            cardsGrid.appendChild(card);
        });

        regionSection.appendChild(regionHeader);
        regionSection.appendChild(cardsGrid);
        container.appendChild(regionSection);
    });
}

        async function main() {
            const csvText = await fetchCSV("gabung.csv");
            if (!csvText) return;
            const { headers, data: rawData } = parseCSV(csvText);

            // Try to fetch abai.csv and build a set of PKK values to ignore
            let abaiSet = new Set();
            try {
                const abaiText = await fetchCSV("abai.csv");
                if (abaiText) {
                    const lines = abaiText.split("\n").map(l => l.trim()).filter(Boolean);
                    if (lines.length) {
                        // Remove header line if it contains header name
                        if (/no_pkk_inaportnet/i.test(lines[0])) lines.shift();
                        lines.forEach(line => {
                            // support values separated by commas and extra commas/empty items
                            line.split(",").forEach(v => {
                                const t = (v || "").trim();
                                if (t) abaiSet.add(t);
                            });
                        });
                    }
                }
            } catch (e) {
                console.warn("Could not load abai.csv — proceeding without exclusions.", e);
            }

            // Filter out rows whose no_pkk_inaportnet appears in abaiSet
            const filtered = rawData.filter(r => {
                const key = (r["no_pkk_inaportnet"] || "").trim();
                return !key || !abaiSet.has(key);
            });
            const removedCount = rawData.length - filtered.length;
            if (removedCount > 0) console.info(`Excluded ${removedCount} rows based on abai.csv`);

            globalHeaders = headers;
            globalData = filtered;

            renderPelabuhanCards(filtered);
            populateTable(headers, filtered);
            populatePelabuhanFilter(filtered);
            populateYearFilter(filtered);
            attachPelabuhanFilterListener();
            attachYearFilterListener();
            
            // Update chart statistics on initial load
            updateChartStats(filtered);

            const { labels, values } = aggregateByMonth(filtered);
            const ctx = document.getElementById("barChart").getContext("2d");
            barChart = buildBarChart(ctx, labels, values);
         }

        // New: download gabung.csv by fetching as blob then triggering a download
        async function downloadGabung() {
            const btn = document.getElementById("downloadGabungBtn");
            if (btn) btn.disabled = true;
            try {
                // Try XLSX first
                try {
                    const resp = await fetch("gabung.xlsx", { cache: "no-store" });
                    if (!resp.ok) throw new Error("gabung.xlsx not available");
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "gabung.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1500);
                    return;
                } catch (errX) {
                    console.warn("gabung.xlsx not found, falling back to gabung.csv:", errX);
                }

                // Fallback to CSV
                const respCsv = await fetch("gabung.csv", { cache: "no-store" });
                if (!respCsv.ok) throw new Error("gabung.csv not available");
                const blobCsv = await respCsv.blob();
                const urlCsv = URL.createObjectURL(blobCsv);
                const aCsv = document.createElement("a");
                aCsv.href = urlCsv;
                aCsv.download = "gabung.csv";
                document.body.appendChild(aCsv);
                aCsv.click();
                aCsv.remove();
                setTimeout(() => URL.revokeObjectURL(urlCsv), 1500);
            } catch (err) {
                console.error("Download gabung failed:", err);
                alert("Gagal mendownload gabung.xlsx atau gabung.csv. Periksa file dan hak akses server.");
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        main();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>
  // Enforce session + 30-minute inactivity logout
  if (typeof enforceAuth === 'function') {
    enforceAuth();
  }
</script>
</body>
</html>
