<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outstanding Wilayah 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        accent: {
                            500: '#8b5cf6',
                            600: '#7c3aed'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern Chart Styles with Enhanced Visual Effects */
        .chart-wrapper {
            width: 100%;
            height: 400px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }
        
        #barChart {
            width: 100% !important;
            height: 400px !important;
            display: block;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (max-width: 1024px) {
            .chart-wrapper, #barChart { height: 350px !important; }
        }
        
        @media (max-width: 768px) {
            .chart-wrapper, #barChart { height: 300px !important; }
        }
        
        @media (max-width: 640px) {
            .chart-wrapper, #barChart { height: 280px !important; }
        }
        
        /* Notification Toast Styles */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }
        
        .notification-toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification-toast.success {
            border-left: 4px solid #10B981;
        }
        
        .notification-toast.info {
            border-left: 4px solid #3B82F6;
        }
        
        .notification-toast.warning {
            border-left: 4px solid #F59E0B;
        }
        
        .notification-toast.error {
            border-left: 4px solid #EF4444;
        }

        /* Hide chart title */
        #chartTitle { display: none !important; }

        /* Hide filter labels */
        label[for="pelabuhanFilter"],
        label[for="yearFilter"] {
            display: none !important;
        }

        /* Tab styling */
        .tab-button {
            position: relative;
        }
        
        .tab-button:hover {
            background-color: #f9fafb;
        }
        
        .tab-button.active {
            background-color: #eff6ff !important;
            color: #2563eb !important;
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card decorative circle */
        .stat-card .card-circle {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            right: -15px;
            bottom: -15px;
            opacity: 0.15;
            filter: blur(6px);
            pointer-events: none;
        }

        /* Card text styling */
        .stat-title {
            font-size: clamp(0.7rem, 1vw, 0.9rem);
            font-weight: 700;
            line-height: 1.2;
            word-break: break-word;
        }
        
        .stat-value {
            font-size: clamp(0.8rem, 1.8vw, 1.2rem);
            font-weight: 900;
            line-height: 1;
        }

        .pkk-manual {
            font-size: 0.75rem;
            font-weight: 800;
            margin-top: 6px;
            color: rgba(255,255,255,0.95);
            text-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .pelayaran-stats {
            font-size: 0.6rem;
            font-weight: 600;
            line-height: 1.1;
            margin-top: 4px;
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <!-- Modern Header with Tailwind -->
    <header class="relative w-full bg-gradient-to-br from-blue-600 via-purple-600 to-pink-500 py-8 px-2 sm:px-4 lg:px-6 mb-8 overflow-hidden">
        <!-- Background decoration -->
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
        <div class="absolute top-0 left-0 w-64 h-64 bg-purple-400/20 rounded-full -translate-x-32 -translate-y-32 blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-pink-400/20 rounded-full translate-x-32 translate-y-32 blur-3xl"></div>
        
        <!-- GitHub Connection Status Icon -->
        <div class="absolute top-4 right-4 z-20">
            <div id="githubConnectionIcon" class="flex items-center space-x-2 bg-white/20 backdrop-blur-sm rounded-full px-3 py-2 transition-all duration-300">
                <!-- GitHub Icon -->
                <svg id="githubIcon" class="w-6 h-6 text-red-400 transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
                </svg>
                <!-- Status Text -->
                <span id="githubStatusText" class="text-white text-sm font-medium">Connecting...</span>
                <!-- Connection Indicator -->
                <div id="githubConnectionDot" class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
            </div>
        </div>

        <!-- Header content -->
        <div class="relative z-10 text-center">
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-black text-white mb-4 tracking-tight">
                OUTSTANDING WILAYAH 3
            </h1>
            <p class="text-blue-100 text-sm md:text-lg lg:text-xl font-medium">Dashboard Monitoring dan Analisis Data</p>
        </div>
        
        <!-- Decorative elements -->
        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400"></div>
    </header>

    <!-- Tab Navigation -->
    <div class="w-full px-2 sm:px-4 lg:px-6 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="flex border-b border-gray-200 justify-between">
                <div class="flex">
                    <button id="dashboardTab" class="tab-button active px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 bg-blue-50 text-blue-600 border-b-2 border-blue-600">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Dashboard
                    </button>
                    <button id="tabelTab" class="tab-button px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18M8 18h8M8 6h8"></path>
                        </svg>
                        Tabel
                    </button>
                    <button id="billingTab" class="tab-button px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Billing
                    </button>
                    <button id="verifikatorTab" class="tab-button px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Verifikator
                    </button>
                </div>
                <!-- PKK Clear Tab - Positioned at the right -->
                <div class="flex">
                    <button id="pkkClearTab" class="tab-button px-6 py-3 font-semibold text-sm focus:outline-none transition-all duration-200 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        PKK Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab Content -->
    <div id="dashboardContent" class="tab-content">
        <!-- Stats Cards Section -->
    <div class="w-full px-2 sm:px-4 lg:px-6 mb-8">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-100 p-6">
            <div id="pelabuhanCardsContainer">
                <!-- Regional groups will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <section class="w-full px-2 sm:px-4 lg:px-6 mb-8">
        <!-- Chart Container -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <!-- Chart Header -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Data Visualization</h3>
                            <p class="text-sm text-gray-600">Analisis Keberangkatan Bulanan</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-1 text-xs text-gray-500">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span>Live Data</span>
                        </div>
                        <button class="p-1.5 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chart Content -->
            <div class="p-6">
                <h5 id="chartTitle" class="hidden">Departures per Month</h5>
                
                <!-- Modern Chart Stats Row with improved animations and glassmorphism -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Total Data Card -->
                    <div class="group relative bg-gradient-to-br from-blue-500/10 via-blue-400/5 to-transparent rounded-2xl p-5 border border-blue-200/50 backdrop-blur-sm hover:shadow-lg hover:shadow-blue-500/25 transition-all duration-300 hover:scale-[1.02] hover:border-blue-300/70">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 text-xs font-semibold uppercase tracking-wider mb-2">Total Data</p>
                                <p id="totalDataCount" class="text-3xl font-black text-blue-900 tabular-nums">-</p>
                                <div class="flex items-center mt-1">
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse mr-2"></div>
                                    <span class="text-xs text-blue-600/70 font-medium">Live</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-3 bg-blue-500/10 rounded-xl border border-blue-200/50 group-hover:bg-blue-500/20 transition-colors duration-300">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dalam Negeri Card -->
                    <div class="group relative bg-gradient-to-br from-emerald-500/10 via-emerald-400/5 to-transparent rounded-2xl p-5 border border-emerald-200/50 backdrop-blur-sm hover:shadow-lg hover:shadow-emerald-500/25 transition-all duration-300 hover:scale-[1.02] hover:border-emerald-300/70">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative flex items-center justify-between">
                            <div>
                                <p class="text-emerald-600 text-xs font-semibold uppercase tracking-wider mb-2">Dalam Negeri</p>
                                <p id="dnCount" class="text-3xl font-black text-emerald-900 tabular-nums">-</p>
                                <div class="flex items-center mt-1">
                                    <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse mr-2"></div>
                                    <span class="text-xs text-emerald-600/70 font-medium">Domestik</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-3 bg-emerald-500/10 rounded-xl border border-emerald-200/50 group-hover:bg-emerald-500/20 transition-colors duration-300">
                                    <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Luar Negeri Card -->
                    <div class="group relative bg-gradient-to-br from-purple-500/10 via-purple-400/5 to-transparent rounded-2xl p-5 border border-purple-200/50 backdrop-blur-sm hover:shadow-lg hover:shadow-purple-500/25 transition-all duration-300 hover:scale-[1.02] hover:border-purple-300/70">
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative flex items-center justify-between">
                            <div>
                                <p class="text-purple-600 text-xs font-semibold uppercase tracking-wider mb-2">Luar Negeri</p>
                                <p id="lnCount" class="text-3xl font-black text-purple-900 tabular-nums">-</p>
                                <div class="flex items-center mt-1">
                                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse mr-2"></div>
                                    <span class="text-xs text-purple-600/70 font-medium">Internasional</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-3 bg-purple-500/10 rounded-xl border border-purple-200/50 group-hover:bg-purple-500/20 transition-colors duration-300">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PKK Manual Card -->
                    <div class="group relative bg-gradient-to-br from-amber-500/10 via-amber-400/5 to-transparent rounded-2xl p-5 border border-amber-200/50 backdrop-blur-sm hover:shadow-lg hover:shadow-amber-500/25 transition-all duration-300 hover:scale-[1.02] hover:border-amber-300/70">
                        <div class="absolute inset-0 bg-gradient-to-br from-amber-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative flex items-center justify-between">
                            <div>
                                <p class="text-amber-600 text-xs font-semibold uppercase tracking-wider mb-2">PKK Manual</p>
                                <p id="manualCount" class="text-3xl font-black text-amber-900 tabular-nums">-</p>
                                <div class="flex items-center mt-1">
                                    <div class="w-2 h-2 bg-amber-400 rounded-full animate-pulse mr-2"></div>
                                    <span class="text-xs text-amber-600/70 font-medium">Manual</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-3 bg-amber-500/10 rounded-xl border border-amber-200/50 group-hover:bg-amber-500/20 transition-colors duration-300">
                                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modern Chart Container with glassmorphism and improved design -->
                <div class="relative bg-gradient-to-br from-white/80 via-white/40 to-white/80 backdrop-blur-sm rounded-3xl border border-white/20 shadow-2xl shadow-gray-500/10 overflow-hidden">
                    <!-- Chart Background Pattern -->
                    <div class="absolute inset-0 opacity-5">
                        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 2px 2px, #6366F1 1px, transparent 0); background-size: 20px 20px;"></div>
                    </div>
                    
                    <!-- Chart Header Bar -->
                    <div class="relative bg-gradient-to-r from-gray-900/5 via-gray-800/5 to-gray-900/5 px-6 py-4 border-b border-gray-200/30">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-gradient-to-br from-indigo-500/20 to-purple-600/20 rounded-lg backdrop-blur-sm">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900 tracking-tight">Analisis Keberangkatan</h4>
                                    <p class="text-sm text-gray-600 font-medium">Distribusi bulanan per pelabuhan</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2 px-3 py-1.5 bg-emerald-50/80 rounded-full border border-emerald-200/50">
                                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <span class="text-xs text-emerald-700 font-semibold">Real-time</span>
                                </div>
                                <button class="p-2 text-gray-400 hover:text-gray-600 rounded-xl hover:bg-gray-100/50 transition-all duration-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Canvas Container -->
                    <div class="relative p-8">
                        <div class="chart-wrapper relative bg-gradient-to-br from-gray-50/30 to-white/50 rounded-2xl border border-gray-200/30 p-6 backdrop-blur-sm">
                            <canvas id="barChart" class="relative z-10"></canvas>
                            
                            <!-- Loading Overlay -->
                            <div id="chartLoading" class="absolute inset-0 bg-white/80 backdrop-blur-sm rounded-2xl flex items-center justify-center z-20" style="display: none;">
                                <div class="flex flex-col items-center space-y-4">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                    <p class="text-sm font-medium text-gray-600">Memuat data chart...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Legend Enhancement -->
                        <div class="mt-6 flex items-center justify-center space-x-6 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gradient-to-r from-blue-500 to-blue-400 rounded-sm"></div>
                                <span class="text-gray-700 font-medium">Klik bar untuk filter tabel</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-sm"></div>
                                <span class="text-gray-700 font-medium">Data terupdate otomatis</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    </div>

    <!-- Tabel Tab Content -->
    <div id="tabelContent" class="tab-content hidden">
        <!-- Filters and Controls -->
    <div class="w-full px-2 sm:px-4 lg:px-6 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <!-- Server Status and Controls -->
                <div class="flex items-center space-x-4">
                    <div id="serverStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-gray-400 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600 font-medium">Checking server...</span>
                    </div>
                    <button id="toggleServerBtn" onclick="toggleAbaikanServer()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                        Start Server
                    </button>
                </div>
                
                <!-- Filters -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <div>
                        <label for="pelabuhanFilter" class="hidden">Filter by Pelabuhan:</label>
                        <select id="pelabuhanFilter" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 hover:bg-gray-100 min-w-[160px]">
                            <option value="ALL">Semua Pelabuhan</option>
                        </select>
                    </div>
                    <div>
                        <label for="yearFilter" class="hidden">Filter by Tahun:</label>
                        <select id="yearFilter" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 hover:bg-gray-100 min-w-[120px]">
                            <option value="ALL">Semua Tahun</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button id="downloadGabungBtn" type="button" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download Data
                    </button>
                    <button id="clearFilterBtn" type="button" class="px-6 py-2 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="w-full px-2 sm:px-4 lg:px-6 mb-8" id="tableContainer">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gradient-to-r from-gray-800 to-gray-900 text-white">
                        <tr id="table-header" class="text-center">
                            <!-- Table headers will be dynamically inserted here -->
                        </tr>
                        <tr id="table-filter-row" class="bg-gray-100">
                            <!-- Filter inputs will be dynamically inserted here -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200">
                        <!-- Table rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <!-- Billing Tab Content -->
    <div id="billingContent" class="tab-content hidden">
        <div class="w-full px-2 sm:px-4 lg:px-6">
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="p-0">
                    <iframe 
                        src="bill.html" 
                        class="w-full h-screen border-0" 
                        style="min-height: 800px;"
                        title="Billing Dashboard">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Verifikator Tab Content -->
    <div id="verifikatorContent" class="tab-content hidden">
        <div class="w-full px-2 sm:px-4 lg:px-6 py-8">
            <!-- Header -->
            <div class="text-center mb-8 hidden">
                <h2 class="text-lg font-bold text-gray-900 mb-2">Verifikator per Region - 2025</h2>
                <p class="text-gray-600 text-sm">(Daftar verifikator yang bertugas di setiap region)</p>
                <div class="w-24 h-1 bg-gradient-to-r from-green-500 to-emerald-600 mx-auto mt-4 rounded-full"></div>
            </div>

            <!-- Region Subtabs -->
            <div class="mb-4 -mt-8">
                <div class="flex justify-center">
                    <div class="bg-gray-100 p-1 rounded-lg">
                        <button id="kalimantanSubTab" class="px-6 py-2 font-semibold text-sm rounded-md transition-all duration-200 bg-white text-gray-800 shadow-sm">
                            🌳 Kalimantan
                        </button>
                        <button id="jawaSubTab" class="px-6 py-2 font-semibold text-sm rounded-md transition-all duration-200 text-gray-600 hover:text-gray-800">
                            🏛️ Jawa
                        </button>
                        <button id="baliSubTab" class="px-6 py-2 font-semibold text-sm rounded-md transition-all duration-200 text-gray-600 hover:text-gray-800">
                            🏝️ Bali Nusatenggara
                        </button>
                    </div>
                </div>
            </div>

            <!-- Subtab Contents -->
            <!-- Kalimantan Subtab -->
            <div id="kalimantanSubContent" class="subtab-content">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                        <span class="mr-2">🌳</span>
                        Region Kalimantan
                        <span id="kalimantanCount" class="ml-2 text-sm font-normal text-gray-500"></span>
                    </h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="kalimantanCards">
                    <!-- Kalimantan verifikator cards -->
                </div>
            </div>

            <!-- Jawa Subtab -->
            <div id="jawaSubContent" class="subtab-content hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                        <span class="mr-2">🏛️</span>
                        Region Jawa
                        <span id="jawaCount" class="ml-2 text-sm font-normal text-gray-500"></span>
                    </h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="jawaCards">
                    <!-- Jawa verifikator cards -->
                </div>
            </div>

            <!-- Bali Nusatenggara Subtab -->
            <div id="baliSubContent" class="subtab-content hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                        <span class="mr-2">🏝️</span>
                        Region Bali Nusatenggara
                        <span id="baliCount" class="ml-2 text-sm font-normal text-gray-500"></span>
                    </h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="baliCards">
                    <!-- Bali Nusatenggara verifikator cards -->
                </div>
            </div>
        </div>
    </div>

    <!-- PKK Clear Tab Content -->
    <div id="pkkClearContent" class="tab-content hidden">
        <div class="w-full px-2 sm:px-4 lg:px-6 py-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">🗑️ PKK Clear Management</h2>
                <p class="text-gray-600 text-lg">Kelola data PKK yang telah diabaikan</p>
                <div class="w-24 h-1 bg-gradient-to-r from-red-500 to-orange-500 mx-auto mt-4 rounded-full"></div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Total Ignored Items -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total PKK Diabaikan</p>
                            <p id="totalIgnoredCount" class="text-2xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-red-100 rounded-lg p-3">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- GitHub Storage -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">GitHub Storage</p>
                            <p id="githubCount" class="text-2xl font-bold text-green-600">0</p>
                            <p id="githubStatus" class="text-xs text-gray-500 mt-1">Loading...</p>
                            <p id="githubDebug" class="text-xs text-gray-400 mt-1" style="display: none;"></p>
                        </div>
                        <div class="bg-green-100 rounded-lg p-3">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Local Browser Storage -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Browser Storage</p>
                            <p id="localStorageCount" class="text-2xl font-bold text-blue-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">localStorage</p>
                        </div>
                        <div class="bg-blue-100 rounded-lg p-3">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Sync Status -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Sync Status</p>
                            <p id="syncStatusText" class="text-sm font-bold text-gray-600">Loading...</p>
                            <div class="flex items-center mt-2">
                                <div id="syncStatusIndicator" class="w-3 h-3 bg-gray-300 rounded-full"></div>
                                <span class="ml-2 text-xs text-gray-500">Live Status</span>
                            </div>
                        </div>
                        <div class="bg-purple-100 rounded-lg p-3">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6" style="display: none;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Quick Actions</p>
                            <p class="text-lg font-bold text-green-600">Management</p>
                        </div>
                        <div class="bg-green-100 rounded-lg p-3">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Storage Comparison -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" style="display: none;">
                <!-- GitHub Storage Info -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-green-100 rounded-lg p-2 mr-3">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265L11.095 9l2.696.002a1 1 0 01.994 1.077l-1 13a1 1 0 01-1.992-.154L12.728 14H9a1 1 0 01-.943-1.332L10.684 3.684a1 1 0 011.632-.633zM9 0a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0V4H7a1 1 0 110-2h1V1a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">GitHub Repository</h3>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span id="githubConnectionStatus" class="font-medium text-green-600">Connected</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Repository:</span>
                            <span class="font-medium text-gray-800">Hadi197/Outstanding</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">File:</span>
                            <span class="font-medium text-gray-800">abai.csv</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Entries:</span>
                            <span id="githubEntriesDisplay" class="font-bold text-green-600">0</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center text-sm text-green-600">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Persistent across devices & browsers
                        </div>
                    </div>
                </div>

                <!-- Browser Storage Info -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 rounded-lg p-2 mr-3">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Browser localStorage</h3>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-medium text-blue-600">Active</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Storage:</span>
                            <span class="font-medium text-gray-800">Browser Cache</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Persistence:</span>
                            <span class="font-medium text-orange-600">Session Only</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Entries:</span>
                            <span id="localEntriesDisplay" class="font-bold text-blue-600">0</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center text-sm text-amber-600">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.732 15c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            Lost when browser cache cleared
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sync Controls -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Data Synchronization</h3>
                    <button id="refreshStatsBtn" onclick="updateIgnoredStats()" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-md transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div id="syncSummary" class="text-sm text-gray-600 mb-4">
                    Checking synchronization status...
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="syncToGithubBtn" onclick="syncLocalToGitHub()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        📤 Sync to GitHub
                    </button>
                    <button id="syncFromGithubBtn" onclick="syncGitHubToLocal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        📥 Sync from GitHub
                    </button>
                    <button id="exportBothBtn" onclick="exportComparisonData()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded-md transition-colors">
                        📊 Export Comparison
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 mb-8 justify-center">
                <button id="refreshIgnoredBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Data
                </button>
                <button id="clearAllIgnoredBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Clear All
                </button>
                <button id="exportIgnoredBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export Data
                </button>
            </div>

            <!-- Ignored PKK List -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Daftar PKK yang Diabaikan
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">Data PKK yang telah ditandai untuk diabaikan</p>
                </div>
                
                <!-- Search and Filter -->
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="searchIgnoredInput" placeholder="Cari PKK Number..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="searchIgnoredBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Ignored Items List -->
                <div class="max-h-96 overflow-y-auto">
                    <div id="ignoredItemsList" class="divide-y divide-gray-200">
                        <!-- Ignored items will be loaded here -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyIgnoredState" class="text-center py-12 hidden">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Tidak Ada Data</h3>
                        <p class="text-gray-600">Belum ada PKK yang diabaikan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function initTabs() {
            const dashboardTab = document.getElementById('dashboardTab');
            const tabelTab = document.getElementById('tabelTab');
            const billingTab = document.getElementById('billingTab');
            const verifikatorTab = document.getElementById('verifikatorTab');
            const pkkClearTab = document.getElementById('pkkClearTab');
            const dashboardContent = document.getElementById('dashboardContent');
            const tabelContent = document.getElementById('tabelContent');
            const billingContent = document.getElementById('billingContent');
            const verifikatorContent = document.getElementById('verifikatorContent');
            const pkkClearContent = document.getElementById('pkkClearContent');

            // Initialize subtabs
            initVerifikatorSubTabs();

            function switchTab(activeTab, activeContent) {
                // Reset all tabs to inactive state
                [dashboardTab, tabelTab, billingTab, verifikatorTab, pkkClearTab].forEach(tab => {
                    tab.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-b-2', 'border-blue-600');
                    tab.classList.add('text-gray-600');
                });
                
                // Hide all content
                [dashboardContent, tabelContent, billingContent, verifikatorContent, pkkClearContent].forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Activate selected tab
                activeTab.classList.add('active', 'bg-blue-50', 'text-blue-600', 'border-b-2', 'border-blue-600');
                activeTab.classList.remove('text-gray-600');
                
                // Show selected content
                activeContent.classList.remove('hidden');
                
                // Special handling for PKK Clear tab
                if (activeContent === pkkClearContent) {
                    loadPkkClearData();
                }
            }

            dashboardTab.addEventListener('click', () => {
                switchTab(dashboardTab, dashboardContent);
            });

            tabelTab.addEventListener('click', () => {
                switchTab(tabelTab, tabelContent);
            });
            
            billingTab.addEventListener('click', () => {
                switchTab(billingTab, billingContent);
            });
            
            verifikatorTab.addEventListener('click', () => {
                switchTab(verifikatorTab, verifikatorContent);
            });
            
            pkkClearTab.addEventListener('click', () => {
                switchTab(pkkClearTab, pkkClearContent);
            });
        }

        // Initialize tabs when page loads
        document.addEventListener('DOMContentLoaded', initTabs);
        
        // Verifikator subtab functionality
        function initVerifikatorSubTabs() {
            const kalimantanTab = document.getElementById('kalimantanSubTab');
            const jawaTab = document.getElementById('jawaSubTab');
            const baliTab = document.getElementById('baliSubTab');
            const kalimantanContent = document.getElementById('kalimantanSubContent');
            const jawaContent = document.getElementById('jawaSubContent');
            const baliContent = document.getElementById('baliSubContent');

            function showSubTab(activeTab, activeContent) {
                // Reset all subtabs
                [kalimantanTab, jawaTab, baliTab].forEach(tab => {
                    tab.className = 'px-6 py-2 font-semibold text-sm rounded-md transition-all duration-200 text-gray-600 hover:text-gray-800';
                });
                [kalimantanContent, jawaContent, baliContent].forEach(content => {
                    content.classList.add('hidden');
                });

                // Activate selected subtab
                activeTab.className = 'px-6 py-2 font-semibold text-sm rounded-md transition-all duration-200 bg-white text-gray-800 shadow-sm';
                activeContent.classList.remove('hidden');
            }

            kalimantanTab.addEventListener('click', () => showSubTab(kalimantanTab, kalimantanContent));
            jawaTab.addEventListener('click', () => showSubTab(jawaTab, jawaContent));
            baliTab.addEventListener('click', () => showSubTab(baliTab, baliContent));
        }
        
        // Verifikator functionality
        let verifikatorData = [];
        
        async function loadVerifikatorData() {
            try {
                const csvData = await fetchCSV('bill.csv');
                if (!csvData) {
                    console.error('No CSV data received');
                    return;
                }
                
                const parsedResult = parseCSV(csvData);
                console.log('Parsed result:', parsedResult);
                
                if (!parsedResult || !parsedResult.data || !Array.isArray(parsedResult.data)) {
                    console.error('parseCSV did not return valid data structure');
                    return;
                }
                
                // Debug: Check available columns in first few rows
                console.log('Available columns:', parsedResult.headers);
                console.log('Sample data (first 3 rows):', parsedResult.data.slice(0, 3));
                
                // Check for different possible column names for verified_by
                const sampleRow = parsedResult.data[0];
                console.log('Sample row keys:', Object.keys(sampleRow));
                console.log('Sample row values:', sampleRow);
                
                // Look for branch-related columns
                const branchColumns = Object.keys(sampleRow).filter(key => 
                    key.toLowerCase().includes('branch') || 
                    key.toLowerCase().includes('cabang') || 
                    key.toLowerCase().includes('pelabuhan')
                );
                console.log('Possible branch columns:', branchColumns);
                
                // Look for period-related columns  
                const periodColumns = Object.keys(sampleRow).filter(key =>
                    key.toLowerCase().includes('period') || 
                    key.toLowerCase().includes('tanggal') ||
                    key.toLowerCase().includes('date') ||
                    key.toLowerCase().includes('bulan') ||
                    key.toLowerCase().includes('tahun')
                );
                console.log('Possible period columns:', periodColumns);
                
                // Look for verifikator-related columns (exclude date columns)
                const verifikatorColumns = Object.keys(sampleRow).filter(key =>
                    key === 'verified_by' ||
                    key === 'status_nota' ||
                    ((key.toLowerCase().includes('verif') || 
                      key.toLowerCase().includes('valid') ||
                      key.toLowerCase().includes('check') ||
                      key.toLowerCase().includes('approve') ||
                      key.toLowerCase().includes('status') ||
                      key.toLowerCase().includes('nota') ||
                      key.toLowerCase().includes('by')) && 
                     !key.toLowerCase().includes('date'))
                );
                console.log('Possible verifikator columns:', verifikatorColumns);
                
                // Try to find the actual column names by checking sample data
                const sampleRowForColumns = parsedResult.data[0];
                const allKeys = Object.keys(sampleRowForColumns);
                
                // Find branch column
                let branchColumn = allKeys.find(key => 
                    key === 'name_branch' || 
                    key.toLowerCase().includes('branch') || 
                    key.toLowerCase().includes('cabang') || 
                    key.toLowerCase().includes('pelabuhan')
                ) || 'name_branch';
                
                // Find period column
                let periodColumn = allKeys.find(key =>
                    key === 'Periode' ||
                    key.toLowerCase().includes('period') || 
                    key.toLowerCase().includes('tanggal') ||
                    key.toLowerCase().includes('date') ||
                    key.toLowerCase().includes('bulan')
                ) || 'Periode';
                
                // Find verifikator column - prioritize verified_by and avoid verified_date
                let verifikatorColumn = allKeys.find(key =>
                    key === 'verified_by'
                ) || allKeys.find(key =>
                    key === 'status_nota' ||
                    (key.toLowerCase().includes('verif') && !key.toLowerCase().includes('date')) ||
                    (key.toLowerCase().includes('valid') && !key.toLowerCase().includes('date')) ||
                    key.toLowerCase().includes('check') ||
                    key.toLowerCase().includes('approve') ||
                    key.toLowerCase().includes('status') ||
                    key.toLowerCase().includes('nota') ||
                    (key.toLowerCase().includes('by') && !key.toLowerCase().includes('date'))
                ) || 'verified_by';
                
                console.log('Using columns - Branch:', branchColumn, 'Period:', periodColumn, 'Verifikator:', verifikatorColumn);
                
                verifikatorData = parsedResult.data.filter(row => {
                    const branchValue = row[branchColumn];
                    const periodValue = row[periodColumn]; 
                    const verifikatorValue = row[verifikatorColumn];
                    
                    const hasBasicData = row && branchValue && periodValue;
                    const hasVerified = verifikatorValue && verifikatorValue.toString().trim() !== '';
                    
                    return hasBasicData && hasVerified;
                });
                
                console.log('Total rows in CSV:', parsedResult.data.length);
                console.log(`Rows with ${branchColumn} and ${periodColumn}:`, parsedResult.data.filter(row => row && row[branchColumn] && row[periodColumn]).length);
                console.log(`Rows with ${verifikatorColumn}:`, parsedResult.data.filter(row => row && row[verifikatorColumn] && row[verifikatorColumn].toString().trim() !== '').length);
                console.log('Loaded verifikator data:', verifikatorData.length, 'records');
                
                // Create column mapping object to pass to other functions
                const columnMapping = {
                    branch: branchColumn,
                    period: periodColumn,
                    verifikator: verifikatorColumn
                };
                window.verifikatorColumnMapping = columnMapping; // Store globally for filter events
                
                if (verifikatorData.length === 0) {
                    console.warn('No verifikator data found. Checking column names...');
                    // Show all unique column names for debugging
                    const allColumns = new Set();
                    parsedResult.data.slice(0, 10).forEach(row => {
                        Object.keys(row).forEach(key => allColumns.add(key));
                    });
                    console.log('All available columns:', Array.from(allColumns));
                }
                
                updateVerifikatorCards(columnMapping);
                
            } catch (error) {
                console.error('Error loading verifikator data:', error);
            }
        }
        
        function updateVerifikatorCards(columnMapping = {}) {
            console.log('updateVerifikatorCards called with:', columnMapping);
            console.log('verifikatorData length:', verifikatorData.length);
            
            // Use dynamic column names or defaults
            const verifikatorCol = columnMapping.verifikator || 'verified_by';
            const branchCol = columnMapping.branch || 'name_branch';
            
            console.log('Using columns - Verifikator:', verifikatorCol, 'Branch:', branchCol);
            
            // Group verifikators by their branches and count data
            const verifikatorBranches = {};
            const verifikatorDataCount = {};
            
            verifikatorData.forEach(row => {
                const verifikator = row[verifikatorCol];
                const branch = row[branchCol];
                
                if (verifikator && verifikator.trim() !== '' && branch && branch.trim() !== '') {
                    const cleanVerifikator = verifikator.trim();
                    const cleanBranch = branch.trim();
                    
                    if (!verifikatorBranches[cleanVerifikator]) {
                        verifikatorBranches[cleanVerifikator] = new Set();
                        verifikatorDataCount[cleanVerifikator] = 0;
                    }
                    verifikatorBranches[cleanVerifikator].add(cleanBranch);
                    verifikatorDataCount[cleanVerifikator]++;
                }
            });

            // Regional grouping mapping - same as dashboard
            const regionalMapping = {
                'Kalimantan': ['BANJARMASIN', 'PONTIANAK', 'SAMARINDA', 'BALIKPAPAN', 'KOTABARU', 'SAMPIT', 'KUMAI'],
                'Jawa': ['JAKARTA', 'SURABAYA', 'SEMARANG', 'CIREBON', 'CILACAP', 'TANJUNG PRIOK'],
                'Bali Nusatenggara': ['BENOA', 'LEMBAR', 'BIMA', 'KUPANG', 'TENAU', 'CELUKAN BAWANG']
            };

            // Group verifikators by region
            const regionalVerifikators = {
                'Kalimantan': {},
                'Jawa': {},
                'Bali Nusatenggara': {}
            };
            
            Object.keys(verifikatorBranches).forEach(verifikator => {
                const branches = Array.from(verifikatorBranches[verifikator]);
                
                branches.forEach(branch => {
                    let assignedRegion = null;
                    
                    // Find which region this branch belongs to
                    for (const [region, regionBranches] of Object.entries(regionalMapping)) {
                        if (regionBranches.some(rb => branch.toUpperCase().includes(rb))) {
                            assignedRegion = region;
                            break;
                        }
                    }
                    
                    // If no specific region found, assign to Jawa as default
                    if (!assignedRegion) {
                        assignedRegion = 'Jawa';
                    }
                    
                    if (!regionalVerifikators[assignedRegion][verifikator]) {
                        regionalVerifikators[assignedRegion][verifikator] = new Set();
                    }
                    regionalVerifikators[assignedRegion][verifikator].add(branch);
                });
            });
            
            console.log('Regional verifikators:', regionalVerifikators);
            
            // Clear all subtab containers
            const kalimantanContainer = document.getElementById('kalimantanCards');
            const jawaContainer = document.getElementById('jawaCards');
            const baliContainer = document.getElementById('baliCards');
            
            if (!kalimantanContainer || !jawaContainer || !baliContainer) {
                console.error('Subtab containers not found');
                return;
            }
            
            kalimantanContainer.innerHTML = '';
            jawaContainer.innerHTML = '';
            baliContainer.innerHTML = '';
            
            const modernColors = [
                'bg-gradient-to-br from-blue-50 to-blue-100 text-blue-800 border-blue-200',
                'bg-gradient-to-br from-green-50 to-green-100 text-green-800 border-green-200',
                'bg-gradient-to-br from-purple-50 to-purple-100 text-purple-800 border-purple-200',
                'bg-gradient-to-br from-pink-50 to-pink-100 text-pink-800 border-pink-200',
                'bg-gradient-to-br from-indigo-50 to-indigo-100 text-indigo-800 border-indigo-200',
                'bg-gradient-to-br from-yellow-50 to-yellow-100 text-yellow-800 border-yellow-200',
                'bg-gradient-to-br from-red-50 to-red-100 text-red-800 border-red-200',
                'bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 border-gray-200',
                'bg-gradient-to-br from-cyan-50 to-cyan-100 text-cyan-800 border-cyan-200',
                'bg-gradient-to-br from-teal-50 to-teal-100 text-teal-800 border-teal-200'
            ];
            
            // Regional icons
            const regionIcons = {
                'Kalimantan': '🌴',
                'Jawa': '🏛️', 
                'Bali Nusatenggara': '🏝️'
            };
            
            // Update subtab contents
            Object.keys(regionalVerifikators).forEach(region => {
                const regionData = regionalVerifikators[region];
                const verifikatorList = Object.keys(regionData);
                
                // Get container for this region
                let container;
                let countElementId;
                if (region === 'Kalimantan') {
                    container = kalimantanContainer;
                    countElementId = 'kalimantanCount';
                } else if (region === 'Jawa') {
                    container = jawaContainer;
                    countElementId = 'jawaCount';
                } else if (region === 'Bali Nusatenggara') {
                    container = baliContainer;
                    countElementId = 'baliCount';
                }
                
                if (!container) return;
                
                // Update count in header
                const countElement = document.getElementById(countElementId);
                if (countElement) {
                    const filteredCount = verifikatorList.filter(verifikator => {
                        const upperName = verifikator.toUpperCase().trim();
                        return upperName !== 'SYSTEM' && upperName !== 'ADMIN SYSTEM';
                    }).length;
                    countElement.textContent = `(${filteredCount} verifikator)`;
                }
                
                // Filter out SYSTEM and ADMIN SYSTEM, then sort by data count (highest first)
                const filteredAndSortedVerifikators = verifikatorList
                    .filter(verifikator => {
                        const upperName = verifikator.toUpperCase().trim();
                        return upperName !== 'SYSTEM' && upperName !== 'ADMIN SYSTEM';
                    })
                    .sort((a, b) => {
                        const dataCountA = verifikatorDataCount[a] || 0;
                        const dataCountB = verifikatorDataCount[b] || 0;
                        return dataCountB - dataCountA; // Sort by data count descending
                    });
                
                filteredAndSortedVerifikators.forEach((verifikator, index) => {
                const colorClass = modernColors[index % modernColors.length];
                const branches = Array.from(regionData[verifikator]);
                const branchText = branches.join(', ');
                const dataCount = verifikatorDataCount[verifikator] || 0;
                
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl p-6 border shadow-md hover:shadow-lg transition-all duration-200 min-h-[300px]`;
                
                // Calculate duration categories for this verifikator
                const verifikatorRows = verifikatorData.filter(row => 
                    row[verifikatorCol] && row[verifikatorCol].trim() === verifikator
                );
                
                const durationCounts = {
                    lessThan1: 0,
                    oneToTwo: 0,
                    threeToTen: 0,
                    moreThan10: 0
                };
                
                verifikatorRows.forEach(row => {
                    const lamaNota = parseInt(row['Lama_Nota']) || 0;
                    if (lamaNota < 1) durationCounts.lessThan1++;
                    else if (lamaNota <= 2) durationCounts.oneToTwo++;
                    else if (lamaNota <= 10) durationCounts.threeToTen++;
                    else durationCounts.moreThan10++;
                });
                
                const total = dataCount;
                
                card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${verifikator}</h3>
                                <p class="text-2xl font-bold text-gray-900">${total.toLocaleString()}</p>
                                <p class="text-xs text-gray-500">Total</p>
                            </div>
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="mb-3 p-2 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-600">📍 ${branchText}</div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-green-800">< 1 hari</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-green-800">${durationCounts.lessThan1.toLocaleString()}</div>
                                    <div class="text-xs text-green-600">${total > 0 ? ((durationCounts.lessThan1/total)*100).toFixed(2) : 0}%</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-blue-800">1-2 hari</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-blue-800">${durationCounts.oneToTwo.toLocaleString()}</div>
                                    <div class="text-xs text-blue-600">${total > 0 ? ((durationCounts.oneToTwo/total)*100).toFixed(2) : 0}%</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-yellow-800">3-10 hari</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-yellow-800">${durationCounts.threeToTen.toLocaleString()}</div>
                                    <div class="text-xs text-yellow-600">${total > 0 ? ((durationCounts.threeToTen/total)*100).toFixed(2) : 0}%</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                    <span class="text-sm font-medium text-red-800">> 10 hari</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-red-800">${durationCounts.moreThan10.toLocaleString()}</div>
                                    <div class="text-xs text-red-600">${total > 0 ? ((durationCounts.moreThan10/total)*100).toFixed(2) : 0}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                
                /* Old HTML:
                card.innerHTML = `
                    <div class="font-medium text-sm mb-2">� ${verifikator}</div>
                    <div class="text-xs opacity-75">
                        <div class="mb-1">� ${branchText}</div>
                        <div class="mb-1">📊 ${total.toLocaleString()} data</div>
                        <div>${branches.length} cabang</div>
                    </div>
                */
                container.appendChild(card);
                });
            });
        }
        

        

        

        
        // Load verifikator data when tab is clicked
        document.addEventListener('DOMContentLoaded', () => {
            const verifikatorTab = document.getElementById('verifikatorTab');
            if (verifikatorTab) {
                verifikatorTab.addEventListener('click', () => {
                    if (verifikatorData.length === 0) {
                        // Add a small delay to ensure tab content is visible
                        setTimeout(() => {
                            loadVerifikatorData();
                        }, 100);
                    } else {
                        // If data is already loaded, just update the cards
                        setTimeout(() => {
                            updateVerifikatorCards(window.verifikatorColumnMapping || {});
                        }, 100);
                    }
                });
            }
        });
        
        async function fetchCSV(filePath) {
            try {
                const response = await fetch(filePath);
                const data = await response.text();
                return data;
            } catch (error) {
                console.error("Failed to fetch CSV file:", error);
                return null;
            }
        }

        function parseCSV(csvText) {
            // Debug: Check raw input
            console.log('parseCSV input length:', csvText.length);
            console.log('First 100 characters:', csvText.substring(0, 100));
            
            // Split rows and filter empty ones
            const rows = csvText.split(/\r?\n/).filter(row => row.trim() !== "");
            console.log('Total rows after split:', rows.length);
            
            if (rows.length === 0) {
                console.error('No rows found in CSV');
                return { headers: [], data: [] };
            }
            
            // Get headers - check for BOM or other issues
            const firstRow = rows[0];
            console.log('First row raw:', firstRow);
            console.log('First row char codes:', Array.from(firstRow.substring(0, 20)).map(c => c.charCodeAt(0)));
            
            // Remove potential BOM and split by comma
            const cleanFirstRow = firstRow.replace(/^\uFEFF/, ''); // Remove BOM if present
            const headers = cleanFirstRow.split(",");
            console.log('Headers after split:', headers);
            console.log('Headers count:', headers.length);
            
            if (headers.length < 2) {
                console.error('Header parsing failed - only got', headers.length, 'columns');
                console.log('Trying alternative splits...');
                
                // Try semicolon if comma fails
                const altHeaders = cleanFirstRow.split(";");
                console.log('Alt headers (semicolon):', altHeaders);
                
                if (altHeaders.length > headers.length) {
                    headers = altHeaders;
                    console.log('Using semicolon separator');
                }
            }
            
            const data = rows.slice(1).map((row, rowIndex) => {
                const values = [];
                let current = "";
                let insideQuotes = false;

                for (let char of row) {
                    if (char === '"' && insideQuotes) {
                        insideQuotes = false;
                    } else if (char === '"' && !insideQuotes) {
                        insideQuotes = true;
                    } else if (char === "," && !insideQuotes) {
                        values.push(current.trim());
                        current = "";
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                // Debug first few rows
                if (rowIndex < 3) {
                    console.log(`Row ${rowIndex + 1} values (${values.length}):`, values);
                }

                return headers.reduce((acc, header, index) => {
                    acc[header] = values[index] ? values[index].replace(/^"|"$/g, "") : "";
                    return acc;
                }, {});
            });
            
            console.log('Final parsed result - Headers:', headers.length, 'Data rows:', data.length);
            return { headers, data };
        }

        // Mapping label header tampilan -> field asli
        const HEADER_MAP = {
            no_pkk: "PKK",
            no_pkk_inaportnet: "PKK INAPORTNET",
            nomor_spb: "SPB",
            no_pkk_spb: "NO PKK",          // <-- added
            company_name: "AGEN",          // <-- added
            departure_date: "KEBERANGKATAN", // <-- added
            name_process_code: "STATUS",
            gt: "GRT",
            loa: "LOA",
            waktu_tolak: "TGL/JAM",
            vessel_name: "NAMA KAPAL",
            vessel_name_spb: "NAMA KAPAL", // mapping baru
            NO: "NO",
            PELABUHAN: "PELABUHAN",
            PELAYARAN: "PELAYARAN",
            zone: "ZONA",
        };

        function populateTable(headers, data) {
        const tableHeader = document.getElementById("table-header");
        const tableBody = document.getElementById("table-body");
        const tableFilterRow = document.getElementById("table-filter-row");

        // Clear existing table content
        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";
        tableFilterRow.innerHTML = "";

        // Kolom yang ingin disembunyikan
        const hiddenCols = new Set([
            "name_branch", "no_pkk_wasop", "waktu_tolak",
            "zone_lhgk", "no_pkk_lhgk", "PKK", "no_pkk",
            "status_nota",
            "nomor_pkk",           // hide kolom nomor_pkk
            "vessel_name_wasop"    // hide kolom vessel_name_wasop
        ]);
        const updatedHeaders = [
            "NO",
            ...headers.filter(h => !hiddenCols.has(h)),
            "PELABUHAN",
            "PELAYARAN",
            "AKSI"
        ];

        // Populate table headers (pakai label tampilan)
        updatedHeaders.forEach(header => {
            const th = document.createElement("th");
            th.className = "px-4 py-3 text-xs font-semibold uppercase tracking-wider";
            th.textContent = HEADER_MAP[header] || header;
            tableHeader.appendChild(th);
        });

        // --- Filter row ---
        updatedHeaders.forEach(header => {
            const th = document.createElement("th");
            th.className = "px-4 py-2";
            if (header === "NO" || header === "AKSI") {
                th.innerHTML = "";
            } else {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "w-full px-2 py-1 text-xs text-gray-800 bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none";
                input.style.minWidth = "60px";
                input.placeholder = "Filter";
                input.addEventListener("input", function() {
                    filterTableByHeader();
                });
                th.appendChild(input);
            }
            tableFilterRow.appendChild(th);
        });

        // Populate table rows (tetap pakai key asli untuk ambil data)
        data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 transition-colors duration-150";
            updatedHeaders.forEach(header => {
                const td = document.createElement("td");
                td.className = "px-4 py-3 text-xs whitespace-nowrap";
                if (header === "NO") {
                    td.textContent = index + 1;
                    td.className += " font-medium text-gray-900";
                } else if (header === "PELABUHAN") {
                    td.textContent = row["name_branch"] || "";
                } else if (header === "PELAYARAN") {
                    if (row["no_pkk_inaportnet"]?.includes("PKK.DN")) {
                        td.textContent = "Dalam Negeri";
                        td.className += " text-green-600 font-medium";
                    } else if (row["no_pkk_inaportnet"]?.includes("PKK.LN")) {
                        td.textContent = "Luar Negeri";
                        td.className += " text-blue-600 font-medium";
                    } else {
                        td.textContent = "";
                    }
                } else if (header === "AKSI") {
                    // Tambahkan tombol Abaikan jika ada no_pkk_inaportnet
                    if (row["no_pkk_inaportnet"]) {
                        const button = document.createElement("button");
                        button.className = "px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-medium rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1";
                        button.textContent = "Abaikan";
                        // Pass full row data to capture port name and other details
                        button.onclick = () => handleAbaikan(row["no_pkk_inaportnet"], button, tr, row);
                        td.appendChild(button);
                    } else {
                        td.textContent = "-";
                        td.className += " text-gray-400";
                    }
                } else {
                    td.textContent = row[header] || "";
                }
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    // Filter table by filter row input
    function filterTableByHeader() {
        const tableBody = document.getElementById("table-body");
        const tableFilterRow = document.getElementById("table-filter-row");
        const filterInputs = Array.from(tableFilterRow.querySelectorAll("input"));
        const trs = Array.from(tableBody.querySelectorAll("tr"));

        trs.forEach(tr => {
            let show = true;
            filterInputs.forEach((input, idx) => {
                const val = input.value.trim().toLowerCase();
                if (val) {
                    const td = tr.children[idx + 1]; // skip NO column
                    if (td && !td.textContent.toLowerCase().includes(val)) {
                        show = false;
                    }
                }
            });
            tr.style.display = show ? "" : "none";
        });
    }

        function aggregateByMonth(data) {
            const monthCounts = {};
            data.forEach(row => {
                const departureDate = row["departure_date"];
                if (!departureDate) return;

                const monthKey = departureDate.slice(0, 7); // Extract YYYY-MM format
                const year = departureDate.slice(0, 4); // Extract year
                
                // Only include data from 2024 and 2025
                if (year === "2024" || year === "2025") {
                    monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                }
            });

            const labels = Object.keys(monthCounts).sort();
            const values = labels.map(label => monthCounts[label]);
            return { labels, values };
        }

        let selectedMonth = null;

        // Modern notification system
        function showNotification(message, type = 'info', duration = 3000) {
            // Remove existing notifications
            const existingToasts = document.querySelectorAll('.notification-toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new notification
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            
            const icons = {
                success: '✅',
                info: 'ℹ️',
                warning: '⚠️',
                error: '❌'
            };
            
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-lg">${icons[type] || icons.info}</span>
                    <span class="text-sm font-medium text-gray-800">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        function buildBarChart(ctx, labels, values) {
	// Ultra-modern gradient color palette with enhanced visual appeal
	const modernColors = [
		{ primary: "#6366F1", secondary: "#8B5CF6", tertiary: "#A855F7", bg: "rgba(99, 102, 241, 0.08)" },
		{ primary: "#10B981", secondary: "#059669", tertiary: "#047857", bg: "rgba(16, 185, 129, 0.08)" },
		{ primary: "#F59E0B", secondary: "#D97706", tertiary: "#B45309", bg: "rgba(245, 158, 11, 0.08)" },
		{ primary: "#EF4444", secondary: "#DC2626", tertiary: "#B91C1C", bg: "rgba(239, 68, 68, 0.08)" },
		{ primary: "#3B82F6", secondary: "#2563EB", tertiary: "#1D4ED8", bg: "rgba(59, 130, 246, 0.08)" },
		{ primary: "#8B5CF6", secondary: "#7C3AED", tertiary: "#6D28D9", bg: "rgba(139, 92, 246, 0.08)" },
		{ primary: "#06B6D4", secondary: "#0891B2", tertiary: "#0E7490", bg: "rgba(6, 182, 212, 0.08)" },
		{ primary: "#84CC16", secondary: "#65A30D", tertiary: "#4D7C0F", bg: "rgba(132, 204, 22, 0.08)" },
		{ primary: "#F97316", secondary: "#EA580C", tertiary: "#C2410C", bg: "rgba(249, 115, 22, 0.08)" },
		{ primary: "#EC4899", secondary: "#DB2777", tertiary: "#BE185D", bg: "rgba(236, 72, 153, 0.08)" }
	];

	const chart = new Chart(ctx, {
		type: "bar",
		plugins: [ChartDataLabels],
		data: {
			labels: labels,
			datasets: [{
				label: "Jumlah Keberangkatan",
				data: values,
				backgroundColor: function(context) {
					const chart = context.chart;
					const {ctx, chartArea} = chart;
					if (!chartArea) return modernColors[0].primary;
					
					const dataIndex = context.dataIndex !== undefined ? context.dataIndex : 0;
					const colorSet = modernColors[dataIndex % modernColors.length];
					
					// Create enhanced multi-stop gradient
					const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
					gradient.addColorStop(0, colorSet.primary);
					gradient.addColorStop(0.3, colorSet.secondary);
					gradient.addColorStop(0.7, colorSet.tertiary);
					gradient.addColorStop(1, colorSet.secondary);
					
					return gradient;
				},
				borderColor: function(context) {
					const dataIndex = context.dataIndex !== undefined ? context.dataIndex : 0;
					const colorSet = modernColors[dataIndex % modernColors.length];
					return colorSet.tertiary;
				},
				borderWidth: 2,
				borderRadius: {
					topLeft: 12,
					topRight: 12,
					bottomLeft: 4,
					bottomRight: 4
				},
				borderSkipped: false,
				hoverBackgroundColor: function(context) {
					const chart = context.chart;
					const {ctx, chartArea} = chart;
					const dataIndex = context.dataIndex !== undefined ? context.dataIndex : 0;
					const colorSet = modernColors[dataIndex % modernColors.length];
					
					// Enhanced hover gradient
					const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
					gradient.addColorStop(0, colorSet.tertiary);
					gradient.addColorStop(0.5, colorSet.primary);
					gradient.addColorStop(1, colorSet.secondary);
					
					return gradient;
				},
				hoverBorderColor: function(context) {
					return "#FFFFFF";
				},
				hoverBorderWidth: 3,
				barPercentage: 0.75,
				categoryPercentage: 0.85,
				// Add shadow effect
				shadowOffsetX: 0,
				shadowOffsetY: 4,
				shadowBlur: 12,
				shadowColor: 'rgba(0, 0, 0, 0.15)',
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			interaction: {
				intersect: false,
				mode: 'index'
			},
			animation: {
				duration: 2000,
				easing: 'easeInOutCubic',
				delay: function(context) {
					return context.dataIndex * 150; // Staggered animation
				},
				onComplete: function() {
					// Add subtle entrance animation completion feedback
					this.canvas.style.filter = 'drop-shadow(0 4px 20px rgba(0,0,0,0.1))';
				}
			},
			animations: {
				y: {
					from: function(ctx) {
						return ctx.chart.scales.y.getPixelForValue(0);
					},
					duration: 2000,
					easing: 'easeInOutElastic'
				},
				x: {
					duration: 1500,
					easing: 'easeOutBack'
				}
			},
			layout: { 
				padding: { 
					top: 30, 
					bottom: 25, 
					left: 25, 
					right: 25 
				} 
			},
			plugins: {
				legend: { 
					display: false  // Hide legend for cleaner look
				},
				datalabels: {
					display: true,
					anchor: 'end',
					align: function(context) {
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? 'center' : 'top';
					},
					color: function(context) {
						// Dynamic label color based on bar background
						const dataIndex = context.dataIndex !== undefined ? context.dataIndex : 0;
						const colorSet = modernColors[dataIndex % modernColors.length];
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? '#FFFFFF' : colorSet.tertiary;
					},
					font: {
						size: function(context) {
							// Responsive font size based on chart size
							const chartWidth = context.chart.width;
							return Math.max(10, Math.min(14, chartWidth / 50));
						},
						weight: '700',
						family: "'Inter', 'system-ui', sans-serif"
					},
					formatter: function(value, context) {
						// Enhanced number formatting with animations
						if (value === 0) return '';
						return value.toLocaleString('id-ID');
					},
					backgroundColor: function(context) {
						const dataIndex = context.dataIndex !== undefined ? context.dataIndex : 0;
						const colorSet = modernColors[dataIndex % modernColors.length];
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? 'transparent' : colorSet.bg;
					},
					borderColor: function(context) {
						const dataIndex = context.dataIndex !== undefined ? context.dataIndex : 0;
						const colorSet = modernColors[dataIndex % modernColors.length];
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? 'transparent' : colorSet.primary;
					},
					borderWidth: function(context) {
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? 0 : 1;
					},
					borderRadius: 6,
					padding: {
						top: 4,
						bottom: 4,
						left: 8,
						right: 8
					},
					textStrokeColor: function(context) {
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? 'rgba(0,0,0,0.3)' : 'transparent';
					},
					textStrokeWidth: function(context) {
						const value = context.parsed ? context.parsed.y : 0;
						return value > 500 ? 1 : 0;
					}
				},
				title: {
					display: false  // Title handled by custom header
				},
				tooltip: {
					enabled: true,
					backgroundColor: 'rgba(15, 23, 42, 0.95)',
					titleColor: '#F8FAFC',
					bodyColor: '#E2E8F0',
					cornerRadius: 12,
					padding: 16,
					displayColors: false,
					borderColor: 'rgba(148, 163, 184, 0.2)',
					borderWidth: 1,
					caretPadding: 8,
					caretSize: 6,
					titleFont: {
						size: 14,
						weight: '600',
						family: "'Inter', system-ui, sans-serif"
					},
					bodyFont: {
						size: 13,
						weight: '500',
						family: "'Inter', system-ui, sans-serif"
					},
					callbacks: {
						title: function(context) {
							return `📅 ${context[0].label}`;
						},
						label: function(context) {
							const value = context.parsed.y;
							const percentage = ((value / values.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
							return [
								`🚢 Keberangkatan: ${value.toLocaleString('id-ID')}`,
								`📊 Persentase: ${percentage}%`
							];
						},
						afterLabel: function(context) {
							return '💡 Klik untuk filter data tabel';
						}
					},
					animation: {
						duration: 300,
						easing: 'easeInOutQuart'
					},
					filter: function(tooltipItem) {
						return tooltipItem.parsed.y > 0; // Only show tooltip for non-zero values
					}
				},

			},
			scales: {
				x: {
					grid: {
						display: false,
						drawBorder: false
					},
					ticks: {
						color: "#64748B",
						font: {
							size: 11,
							weight: '600',
							family: "'Inter', system-ui, sans-serif"
						},
						maxRotation: 0,
						minRotation: 0,
						padding: 15,
						callback: function(value, index) {
							// Truncate long labels for better readability
							const label = this.getLabelForValue(value);
							return label.length > 12 ? label.substring(0, 10) + '...' : label;
						}
					},
					border: {
						display: false
					},
					// Add subtle category separators
					afterDraw: function(chart) {
						const ctx = chart.ctx;
						const xAxis = chart.scales.x;
						
						ctx.save();
						ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
						ctx.lineWidth = 1;
						
						xAxis.ticks.forEach((tick, index) => {
							if (index > 0) {
								const x = xAxis.getPixelForTick(index) - (xAxis.getPixelForTick(1) - xAxis.getPixelForTick(0)) / 2;
								ctx.beginPath();
								ctx.moveTo(x, chart.chartArea.top);
								ctx.lineTo(x, chart.chartArea.bottom);
								ctx.stroke();
							}
						});
						
						ctx.restore();
					}
				},
				y: {
					beginAtZero: true,
					grace: '5%', // Add 5% padding to top
					grid: {
						color: function(context) {
							// Gradient grid lines
							return context.tick.value === 0 ? 'rgba(148, 163, 184, 0.3)' : 'rgba(148, 163, 184, 0.1)';
						},
						borderDash: function(context) {
							return context.tick.value === 0 ? [] : [3, 6];
						},
						drawBorder: false,
						lineWidth: function(context) {
							return context.tick.value === 0 ? 2 : 1;
						}
					},
					ticks: {
						color: "#64748B",
						font: {
							size: 11,
							weight: '500',
							family: "'Inter', system-ui, sans-serif"
						},
						padding: 15,
						callback: function(value) {
							// Enhanced number formatting
							if (value >= 1000000) {
								return (value / 1000000).toFixed(1) + 'M';
							} else if (value >= 1000) {
								return (value / 1000).toFixed(0) + 'K';
							}
							return value.toLocaleString('id-ID');
						},
						maxTicksLimit: 8
					},
					border: {
						display: false
					},
					title: {
						display: true,
						text: 'Jumlah Keberangkatan',
						color: '#475569',
						font: {
							size: 12,
							weight: '600',
							family: "'Inter', system-ui, sans-serif"
						},
						padding: 10
					}
				}
			},
			onHover: (event, elements) => {
				const canvas = event.native.target;
				canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				
				// Enhanced hover effects
				if (elements.length > 0) {
					canvas.style.filter = 'brightness(1.05) drop-shadow(0 8px 25px rgba(0,0,0,0.15))';
				} else {
					canvas.style.filter = 'drop-shadow(0 4px 20px rgba(0,0,0,0.1))';
				}
			},
			onClick: function(evt, elements) {
				const chart = this;
				if (elements.length) {
					const idx = elements[0].index;
					const month = chart.data.labels[idx];
					selectedMonth = month;
					
					// Enhanced visual feedback with animations
					const canvas = chart.canvas;
					
					// Add click animation
					canvas.style.transform = 'scale(0.98)';
					canvas.style.transition = 'transform 0.15s ease-out';
					
					setTimeout(() => {
						canvas.style.transform = 'scale(1)';
					}, 150);
					
					// Show loading state
					const loadingElement = document.getElementById('chartLoading');
					if (loadingElement) {
						loadingElement.style.display = 'flex';
						loadingElement.style.opacity = '0';
						loadingElement.style.transition = 'opacity 0.3s ease-in-out';
						
						setTimeout(() => {
							loadingElement.style.opacity = '1';
						}, 50);
						
						setTimeout(() => {
							loadingElement.style.opacity = '0';
							setTimeout(() => {
								loadingElement.style.display = 'none';
							}, 300);
						}, 800);
					}
					
					filterTableByPelabuhan(globalData, document.getElementById("pelabuhanFilter").value, month);
					
					// Visual feedback for selection with subtle highlight
					chart.data.datasets[0].borderWidth = chart.data.labels.map((_, i) => i === idx ? 4 : 2);
					chart.update('none');
					
					// Show success notification
					showNotification(`Filter tabel berdasarkan: ${month}`, 'success');
				} else {
					selectedMonth = null;
					filterTableByPelabuhan(globalData, document.getElementById("pelabuhanFilter").value);
					
					// Reset all borders
					chart.data.datasets[0].borderWidth = 2;
					chart.update('none');
					
					showNotification('Filter dihapus', 'info');
				}
			}
		},

	});

	return chart;
}

        let globalData = [];
        let globalHeaders = [];
        let barChart;
        
        // Server management functions
        let serverCheckInterval;
        
        // Detect if running on localhost or production
        function getApiUrl() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:8001/api';
            } else {
                // Production (Netlify) - use serverless functions
                return '/.netlify/functions';
            }
        }

        // Function to refresh data after persistent abaikan
        async function refreshDataAfterAbaikan() {
            try {
                console.log('🔄 Refreshing data after persistent abaikan...');
                
                // Re-fetch and re-process data
                const csvText = await fetchCSV("gabung.csv");
                if (!csvText) return;
                
                const { headers, data: rawData } = parseCSV(csvText);
                
                // Fetch updated abai data
                const abaiSet = await fetchAbaiData();
                console.log('🔍 DEBUG: abaiSet contents:', Array.from(abaiSet));
                
                // Filter data with updated abai set
                let debugCount = 0;
                const filtered = rawData.filter(r => {
                    const key = (r["no_pkk_inaportnet"] || "").trim();
                    const shouldExclude = key && abaiSet.has(key);
                    if (shouldExclude) {
                        debugCount++;
                        console.log(`🚫 DEBUG: Excluding row with PKK: "${key}"`);
                    }
                    return !shouldExclude;
                });
                
                const removedCount = rawData.length - filtered.length;
                console.log(`🔍 DEBUG: Found ${debugCount} matches, removed ${removedCount} rows`);
                console.log(`🗂️ After refresh: ${removedCount} rows excluded from persistent abai data`);
                
                // Update global data
                globalData = filtered;
                
                // Re-render components
                renderPelabuhanCards(filtered);
                populateTable(headers, filtered);
                
                // Clear and repopulate filters
                const pelabuhanFilter = document.getElementById('pelabuhanFilter');
                const yearFilter = document.getElementById('yearFilter');
                
                if (pelabuhanFilter) {
                    pelabuhanFilter.innerHTML = '<option value="ALL">Semua Pelabuhan</option>';
                    populatePelabuhanFilter(filtered);
                }
                
                if (yearFilter) {
                    yearFilter.innerHTML = '<option value="ALL">Semua Tahun</option>';
                    populateYearFilter(filtered);
                }
                
                // Update chart
                updateBarChart(filtered);
                
                showNotification(`✅ Data berhasil diperbarui. ${removedCount} item diabaikan secara permanen.`, 'success', 4000);
                
            } catch (error) {
                console.error('Error refreshing data after abaikan:', error);
                showNotification('❌ Gagal memperbarui data. Silakan refresh halaman.', 'error');
            }
        }
        
        async function checkServerStatus() {
            try {
                const apiUrl = getApiUrl();
                // Use the correct status endpoint
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const url = `${apiUrl}/status?_t=${timestamp}`;
                console.log('🔍 checkServerStatus calling:', url);
                const response = await fetch(url, {
                    cache: 'no-cache'
                });
                if (response.ok) {
                    const data = await response.json();
                    const isLocal = apiUrl.includes('localhost');
                    const statusMsg = isLocal 
                        ? `Local server - ${data.total_entries || 0} entries`
                        : `Netlify function - ${data.total_entries || 0} entries`;
                    updateServerStatus(true, statusMsg);
                    return true;
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                const isLocal = getApiUrl().includes('localhost');
                const errorMsg = isLocal 
                    ? 'Local server tidak aktif'
                    : 'Netlify function error';
                updateServerStatus(false, errorMsg);
                return false;
            }
        }
        
        function updateServerStatus(isActive, message) {
            const statusDiv = document.getElementById('serverStatus');
            const toggleBtn = document.getElementById('toggleServerBtn');
            const isLocal = getApiUrl().includes('localhost');
            
            if (isActive) {
                statusDiv.innerHTML = `
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-green-600 font-medium">${message}</span>
                `;
                if (isLocal) {
                    toggleBtn.textContent = 'Stop Server';
                    toggleBtn.className = 'px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1';
                } else {
                    toggleBtn.textContent = 'Production Mode';
                    toggleBtn.className = 'px-4 py-2 bg-green-500 cursor-default text-white text-sm font-medium rounded-lg';
                    toggleBtn.disabled = true;
                }
            } else {
                statusDiv.innerHTML = `
                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                    <span class="text-sm text-red-600 font-medium">${message}</span>
                `;
                if (isLocal) {
                    toggleBtn.textContent = 'Start Server';
                    toggleBtn.className = 'px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1';
                    toggleBtn.disabled = false;
                } else {
                    toggleBtn.textContent = 'Function Error';
                    toggleBtn.className = 'px-4 py-2 bg-red-500 cursor-default text-white text-sm font-medium rounded-lg';
                    toggleBtn.disabled = true;
                }
            }
        }
        
        async function toggleAbaikanServer() {
            const isLocal = getApiUrl().includes('localhost');
            
            if (!isLocal) {
                showNotification('Mode production: menggunakan Netlify Functions', 'info', 3000);
                return;
            }
            
            const isActive = await checkServerStatus();
            
            if (isActive) {
                showNotification('Untuk menghentikan server, tekan Ctrl+C di terminal tempat server berjalan', 'info', 5000);
            } else {
                showNotification('Jalankan perintah: python3 abaikan_server.py', 'info', 8000);
                // Show instructions in console
                console.log('=== CARA MENJALANKAN ABAIKAN SERVER (LOCAL) ===');
                console.log('1. Buka terminal baru');
                console.log('2. Navigasi ke folder project: cd /Users/hadipurwana/Documents/PYTHON/OUTALL');
                console.log('3. Jalankan: python3 abaikan_server.py');
                console.log('4. Server akan berjalan di port 8001');
                console.log('5. Refresh halaman ini untuk melihat status server');
            }
        }
        
        // Start checking server status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            // Check server status every 30 seconds
            serverCheckInterval = setInterval(checkServerStatus, 30000);
        });

        // Function to handle "Abaikan" button click
        async function handleAbaikan(noPkkInaportnet, buttonElement, rowElement, rowData = null) {
            if (!noPkkInaportnet) {
                showNotification('No PKK Inaportnet tidak ditemukan', 'error');
                return;
            }

            // Show modal popup for reason selection with full row data
            showAbaiReasonModal(noPkkInaportnet, buttonElement, rowElement, rowData);
        }

        // New function to handle abaikan with reason
        async function handleAbaikanWithReason(noPkkInaportnet, buttonElement, rowElement, reasonData, rowData = null) {
            console.log('🔧 DEBUG: handleAbaikanWithReason called with:', {
                noPkkInaportnet,
                reasonData,
                rowData
            });

            // Disable button and show loading state
            const originalText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = 'Loading...';
            buttonElement.className = buttonElement.className.replace('bg-red-500 hover:bg-red-600', 'bg-gray-400 cursor-not-allowed');

            try {
                // Check if abaikan server is running
                console.log('🔧 DEBUG: Checking server status...');
                const serverActive = await checkServerStatus();
                console.log('🔧 DEBUG: Server active:', serverActive);
                
                // Force server active to true for production Netlify functions
                const currentApiUrl = getApiUrl();
                const isProduction = !currentApiUrl.includes('localhost');
                const actualServerActive = isProduction ? true : serverActive; // Always treat production as active
                
                console.log('🚀 DEBUG: Production mode:', isProduction, 'Actual server active:', actualServerActive);
                
                if (!actualServerActive) {
                    // Don't throw error, use localStorage fallback directly
                    console.log('⚠️ Server not active, using localStorage fallback');
                    
                    // Save to localStorage with reason and row data
                    addToAbaiLocalStorageWithReason(noPkkInaportnet, reasonData, rowData);
                    console.log('💾 Saved to localStorage for persistence with reason:', reasonData.reason);
                    
                    // Show success notification
                    const reasonText = getReasonDisplayText(reasonData.reason);
                    showNotification(`✅ Data berhasil diabaikan: ${noPkkInaportnet} (Disimpan Lokal) - ${reasonText}`, 'success');
                    
                    // Mark row as ignored
                    rowElement.style.transition = 'all 0.5s ease-out';
                    rowElement.style.opacity = '0.5';
                    rowElement.style.background = '#fee2e2';
                    
                    // Replace button with status and reason
                    const reasonDisplay = reasonText.length > 15 ? reasonText.substring(0, 15) + '...' : reasonText;
                    buttonElement.innerHTML = `<span title="${reasonText}">✓ ${reasonDisplay}</span>`;
                    buttonElement.className = 'px-3 py-1 bg-green-600 text-white text-xs font-medium rounded-md cursor-not-allowed';
                    buttonElement.disabled = true;
                    
                    // Auto-hide row and refresh data
                    setTimeout(() => {
                        showNotification('🔄 Memperbarui data...', 'info', 2000);
                        rowElement.style.height = '0';
                        rowElement.style.padding = '0';
                        rowElement.style.margin = '0';
                        setTimeout(() => {
                            rowElement.remove();
                            refreshDataAfterAbaikan();
                        }, 300);
                    }, 1500);
                    
                    return; // Exit function successfully
                }
                
                // Send request to backend (auto-detect local vs production) with reason data
                const apiUrl = getApiUrl();
                console.log('🚀 DEBUG: Sending POST request to:', `${apiUrl}/abaikan`);
                
                // Extract port name from row data
                let pelabuhan = 'Unknown Port';
                if (rowData) {
                    if (rowData.PELABUHAN) {
                        pelabuhan = rowData.PELABUHAN;
                    } else if (rowData.name_branch) {
                        pelabuhan = rowData.name_branch;
                    } else if (rowData.pelabuhan) {
                        pelabuhan = rowData.pelabuhan;
                    } else if (rowData.Pelabuhan) {
                        pelabuhan = rowData.Pelabuhan;
                    } else {
                        // Try to find any column containing "pelabuhan" in the name
                        const portColumn = Object.keys(rowData).find(key => 
                            key.toLowerCase().includes('pelabuhan') || 
                            key.toLowerCase().includes('branch') ||
                            key.toLowerCase().includes('port')
                        );
                        if (portColumn) {
                            pelabuhan = rowData[portColumn];
                        }
                    }
                }
                
                const requestBody = {
                    no_pkk_inaportnet: noPkkInaportnet,
                    pelabuhan: pelabuhan,
                    timestamp: new Date().toISOString(),
                    reason: reasonData.reason,
                    notes: reasonData.notes,
                    reason_timestamp: reasonData.timestamp
                };
                console.log('📤 DEBUG: Request body:', requestBody);
                
                const response = await fetch(`${apiUrl}/abaikan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('📥 DEBUG: Response status:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ DEBUG: API Response:', result);
                    
                    // If server indicates localStorage usage, save locally with reason
                    if (result.use_localstorage) {
                        addToAbaiLocalStorageWithReason(noPkkInaportnet, reasonData, rowData);
                        console.log('💾 Saved to localStorage for persistence with reason:', reasonData.reason);
                    }
                    
                    // Show success notification with storage type info
                    const storageType = result.persistent ? 'GitHub (Tersimpan Permanen)' : 'Lokal (Browser)';
                    const reasonText = getReasonDisplayText(reasonData.reason);
                    showNotification(`✅ Data berhasil diabaikan: ${noPkkInaportnet} (${storageType}) - ${reasonText}`, 'success');
                    
                    // Mark row as ignored (fade out animation)
                    rowElement.style.transition = 'all 0.5s ease-out';
                    rowElement.style.opacity = '0.5';
                    rowElement.style.background = '#fee2e2';
                    
                    // Replace button with status and reason
                    const reasonDisplay = reasonText.length > 15 ? reasonText.substring(0, 15) + '...' : reasonText;
                    buttonElement.innerHTML = `<span title="${reasonText}">✓ ${reasonDisplay}</span>`;
                    buttonElement.className = 'px-3 py-1 bg-green-600 text-white text-xs font-medium rounded-md cursor-not-allowed';
                    buttonElement.disabled = true;
                    
                    // Auto-hide row and refresh data
                    setTimeout(() => {
                        showNotification('🔄 Memperbarui data...', 'info', 2000);
                        rowElement.style.height = '0';
                        rowElement.style.padding = '0';
                        rowElement.style.margin = '0';
                        setTimeout(() => {
                            rowElement.remove();
                            // Refresh data to reflect changes (works with both GitHub and localStorage)
                            refreshDataAfterAbaikan();
                        }, 300);
                    }, 1500);
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error sending abaikan request:', error);
                
                // Show error notification
                showNotification(`Gagal mengabaikan data: ${error.message}`, 'error');
                
                // Reset button state
                buttonElement.disabled = false;
                buttonElement.textContent = originalText;
                buttonElement.className = buttonElement.className.replace('bg-gray-400 cursor-not-allowed', 'bg-red-500 hover:bg-red-600');
            }
        }

        // Helper function to convert reason codes to display text
        function getReasonDisplayText(reasonCode) {
            const reasonMap = {
                'data_duplikat': 'Data Duplikat',
                'data_tidak_valid': 'Data Tidak Valid', 
                'sudah_diproses': 'Sudah Diproses',
                'di_luar_jurisdiksi': 'Di Luar Jurisdiksi',
                'tidak_relevan': 'Tidak Relevan',
                'error_sistem': 'Error Sistem'
            };
            return reasonMap[reasonCode] || reasonCode;
        }

        // Enhanced localStorage function to include reason and port name
        function addToAbaiLocalStorageWithReason(noPkk, reasonData, rowData = null) {
            try {
                // Get existing abai data
                const existingData = JSON.parse(localStorage.getItem(ABAI_STORAGE_KEY) || '[]');
                
                // Determine port name from row data
                let portName = 'Unknown Port';
                console.log('🔧 DEBUG: Row data for port extraction:', rowData);
                
                if (rowData) {
                    console.log('🔧 DEBUG: Available columns:', Object.keys(rowData));
                    
                    // Try different possible column names for port
                    if (rowData.PELABUHAN) {
                        portName = rowData.PELABUHAN;
                        console.log('🔧 DEBUG: Port found in PELABUHAN:', portName);
                    } else if (rowData.name_branch) {
                        portName = rowData.name_branch;
                        console.log('🔧 DEBUG: Port found in name_branch:', portName);
                    } else if (rowData.pelabuhan) {
                        portName = rowData.pelabuhan;
                        console.log('🔧 DEBUG: Port found in pelabuhan:', portName);
                    } else if (rowData.Pelabuhan) {
                        portName = rowData.Pelabuhan;
                        console.log('🔧 DEBUG: Port found in Pelabuhan:', portName);
                    } else {
                        // Try to find any column containing "pelabuhan" in the name
                        const portColumn = Object.keys(rowData).find(key => 
                            key.toLowerCase().includes('pelabuhan') || 
                            key.toLowerCase().includes('branch') ||
                            key.toLowerCase().includes('port')
                        );
                        if (portColumn) {
                            portName = rowData[portColumn];
                            console.log(`🔧 DEBUG: Port found in ${portColumn}:`, portName);
                        } else {
                            console.log('🔧 DEBUG: No port column found, using Unknown Port');
                        }
                    }
                } else {
                    console.log('🔧 DEBUG: No row data provided');
                }
                
                console.log('🔧 DEBUG: Final port name:', portName);
                
                // Add new entry with reason, port name, and additional details
                const newEntry = {
                    pkk: noPkk,
                    port_name: portName,
                    reason: reasonData.reason,
                    notes: reasonData.notes,
                    timestamp: reasonData.timestamp,
                    added_at: new Date().toISOString(),
                    full_row_data: rowData // Store complete row data for reference
                };
                
                // For backward compatibility, also maintain simple array
                const abaiSet = new Set(existingData.map(item => typeof item === 'string' ? item : item.pkk));
                abaiSet.add(noPkk);
                
                // Save detailed data to a separate key
                const detailedKey = ABAI_STORAGE_KEY + '_detailed';
                const detailedData = JSON.parse(localStorage.getItem(detailedKey) || '[]');
                detailedData.push(newEntry);
                localStorage.setItem(detailedKey, JSON.stringify(detailedData));
                
                // Save simple array for main functionality
                localStorage.setItem(ABAI_STORAGE_KEY, JSON.stringify(Array.from(abaiSet)));
                
                console.log(`💾 Saved detailed abai data for ${noPkk}:`, newEntry);
                console.log(`📍 Port Name: ${portName}`);
                console.log(`📋 Reason: ${reasonData.reason}`);
                console.log(`💬 Notes: ${reasonData.notes}`);
            } catch (error) {
                console.error('Error saving detailed abai data:', error);
                // Fallback to simple method
                addToAbaiLocalStorage(noPkk);
            }
        }

        // Function to filter table by pelabuhan and optional month (missing function)
        function filterTableByPelabuhan(data, pelabuhanValue, monthFilter = null) {
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) {
                    pelabuhanKey = "name_branch";
                } else {
                    pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
                }
            }

            let filtered = data.slice();

            // Filter by pelabuhan
            if (pelabuhanValue && pelabuhanValue !== "ALL") {
                filtered = filtered.filter(r => (r[pelabuhanKey] || "") === pelabuhanValue);
            }

            // Filter by month if provided
            if (monthFilter) {
                filtered = filtered.filter(r => {
                    const departureDate = r["departure_date"] || "";
                    return departureDate.slice(0, 7) === monthFilter;
                });
            }

            // Update table with filtered data
            populateTable(globalHeaders, filtered);
            updateBarChart(filtered);
        }

        function populatePelabuhanFilter(data) {
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) {
                    pelabuhanKey = "name_branch";
                } else {
                    pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
                }
            }
            const pelabuhanSet = new Set(data.map(row => row[pelabuhanKey]).filter(Boolean));
            const pelabuhanFilter = document.getElementById("pelabuhanFilter");

            pelabuhanFilter.innerHTML = '<option value="ALL">Semua Pelabuhan</option>';

            pelabuhanSet.forEach(pelabuhan => {
                const option = document.createElement("option");
                option.value = pelabuhan;
                option.textContent = pelabuhan;
                pelabuhanFilter.appendChild(option);
            });
        }

        // Populate year combobox from departure_date (unique years)
        function populateYearFilter(data) {
		const years = new Set();
		data.forEach(row => {
			const d = row["departure_date"];
			if (d && d.length >= 4) years.add(d.slice(0, 4));
		});
		const yearFilter = document.getElementById("yearFilter");
		yearFilter.innerHTML = '<option value="ALL">Semua Tahun</option>';
		Array.from(years).sort().forEach(y => {
			const opt = document.createElement("option");
			opt.value = y;
			opt.textContent = y;
			yearFilter.appendChild(opt);
		});
	}

        // Unified filter: pelabuhan + year (+ optional month)
        function filterByPelabuhanAndYear() {
            const pelabuhan = document.getElementById("pelabuhanFilter").value || "ALL";
            const year = document.getElementById("yearFilter") ? document.getElementById("yearFilter").value : "ALL";
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) pelabuhanKey = "name_branch";
                else pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
            }

            let filtered = globalData.slice();

            if (pelabuhan !== "ALL") filtered = filtered.filter(r => (r[pelabuhanKey] || "") === pelabuhan);
            if (year !== "ALL") filtered = filtered.filter(r => (r["departure_date"] || "").startsWith(year));
            if (selectedMonth) filtered = filtered.filter(r => (r["departure_date"] || "").slice(0,7) === selectedMonth);

            populateTable(globalHeaders, filtered);
            updateBarChart(filtered);
        }

        function clearAllFilters() {
            // Reset combobox
            document.getElementById("pelabuhanFilter").value = "ALL";
            document.getElementById("yearFilter").value = "ALL";
            // Reset selected month
            selectedMonth = null;
            // Show all data in table and chart
            populateTable(globalHeaders, globalData);
            updateBarChart(globalData);
        }

        // Update attachPelabuhanFilterListener to use unified filter
        function attachPelabuhanFilterListener() {
            const pelabuhanFilter = document.getElementById("pelabuhanFilter");
            pelabuhanFilter.addEventListener("change", () => {
                selectedMonth = null;
                filterByPelabuhanAndYear();
            });

            // Tambahkan event listener untuk tombol clear filter
            document.getElementById("clearFilterBtn").addEventListener("click", clearAllFilters);

            // New: download gabung.csv button
            const dlGabung = document.getElementById("downloadGabungBtn");
            if (dlGabung) dlGabung.addEventListener("click", downloadGabung);
        }

        // Year filter listener
        function attachYearFilterListener() {
		const yearFilter = document.getElementById("yearFilter");
		yearFilter.addEventListener("change", () => {
			selectedMonth = null;
			filterByPelabuhanAndYear();
		});
	}

        function updateBarChart(filteredData) {
            const { labels, values } = aggregateByMonth(filteredData);
            if (!barChart) return;

            // Update statistics in chart section
            updateChartStats(filteredData);

            // Update labels and data
            barChart.data.labels = labels;
            barChart.data.datasets[0].data = values;

            // Smooth animation update
            barChart.update('active');
        }

        function initializeChart(data) {
            const ctx = document.getElementById('barChart');
            if (!ctx) {
                console.error('Canvas element "barChart" not found');
                return;
            }

            const { labels, values } = aggregateByMonth(data);
            
            // Destroy existing chart if any
            if (barChart) {
                barChart.destroy();
            }
            
            // Create new chart
            barChart = buildBarChart(ctx, labels, values);
            console.log('Chart initialized successfully');
        }

        function updateChartStats(data) {
            const totalCount = data.length;
            const dnCount = data.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.DN")).length;
            const lnCount = data.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.LN")).length;
            const manualCount = data.filter(r => !((r["no_pkk_inaportnet"] || "").trim())).length;

            // Update the stat cards in chart section
            const totalEl = document.getElementById("totalDataCount");
            const dnEl = document.getElementById("dnCount");
            const lnEl = document.getElementById("lnCount");
            const manualEl = document.getElementById("manualCount");

            if (totalEl) totalEl.textContent = totalCount.toLocaleString();
            if (dnEl) dnEl.textContent = dnCount.toLocaleString();
            if (lnEl) lnEl.textContent = lnCount.toLocaleString();
            if (manualEl) manualEl.textContent = manualCount.toLocaleString();
        }

        /* Updated renderPelabuhanCards: Group by regions (Kalimantan, Jawa, Bali Nusatenggara) */
function renderPelabuhanCards(data) {
    // Definisi mapping region berdasarkan nama pelabuhan/cabang
    const regionMapping = {
        'Kalimantan': {
            keywords: ['kalimantan', 'pontianak', 'banjarmasin', 'samarinda', 'balikpapan', 'ketapang', 'sampit', 'palangkaraya', 'tanjung selor', 'tarakan', 'kotabaru', 'mekar putih', 'sts kotabaru', 'zona batulicin', 'zona satui', 'bunati', 'zona kumai', 'batulicin', 'satui', 'kumai', 'mekarputih', 'bumiharjo', 'bagendang'],
            color: {bg: "linear-gradient(135deg, #a7f3d0, #6ee7b7, #34d399)", circle: "rgba(255,255,255,0.15)"}, // Soft emerald gradient
            icon: '🌳'
        },
        'Jawa': {
            keywords: ['jakarta', 'surabaya', 'semarang', 'cirebon', 'tanjung priok', 'tanjung perak', 'cilacap', 'probolinggo', 'jepara', 'pekalongan', 'banten', 'merak', 'tanjung wangi', 'tanjung intan', 'tanjung emas', 'zona tanjung wangi'],
            color: {bg: "linear-gradient(135deg, #bfdbfe, #93c5fd, #60a5fa)", circle: "rgba(255,255,255,0.15)"}, // Soft blue gradient
            icon: '🏙️'
        },
        'Bali Nusatenggara': {
            keywords: ['bali', 'lombok', 'sumbawa', 'flores', 'kupang', 'denpasar', 'mataram', 'ende', 'waingapu', 'labuan bajo', 'benoa', 'zona lembar', 'lembar', 'celukan bawang'],
            color: {bg: "linear-gradient(135deg, #fce7f3, #fbcfe8, #f9a8d4)", circle: "rgba(255,255,255,0.15)"}, // Soft pink gradient
            icon: '🏝️'
        }
    };

    // Fungsi untuk menentukan region berdasarkan nama
    function getRegion(name) {
        const nameLower = name.toLowerCase();
        for (const [region, config] of Object.entries(regionMapping)) {
            if (config.keywords.some(keyword => nameLower.includes(keyword))) {
                return region;
            }
        }
        return 'Lainnya'; // Default untuk yang tidak cocok
    }

    // Gunakan kolom zone sebagai referensi utama
    let zoneKey = null;
    let branchKey = null;
    for (const h of globalHeaders) {
        if (h.toLowerCase() === "zone" || h.toLowerCase().includes("zone")) {
            zoneKey = h;
        }
        if (h.toLowerCase() === "name_branch" || h.toLowerCase().includes("name_branch")) {
            branchKey = h;
        }
    }
    if (!zoneKey) zoneKey = globalHeaders[0];
    if (!branchKey) branchKey = "name_branch";

    // Kelompokkan data berdasarkan zone/branch
    const zoneGroups = {};
    data.forEach(row => {
        let key = (row[zoneKey] || "").trim();
        if (!key && branchKey && row[branchKey]) {
            key = (row[branchKey] || "Unknown").trim();
        }
        if (!key) key = "Unknown";
        if (!zoneGroups[key]) zoneGroups[key] = [];
        zoneGroups[key].push(row);
    });

    // Kelompokkan zona berdasarkan region
    const regionGroups = {
        'Kalimantan': [],
        'Jawa': [],
        'Bali Nusatenggara': [],
        'Lainnya': []
    };

    Object.entries(zoneGroups).forEach(([zone, rows]) => {
        const region = getRegion(zone);
        regionGroups[region].push({zone, rows});
    });

    // Sort dalam setiap region berdasarkan jumlah data
    Object.keys(regionGroups).forEach(region => {
        regionGroups[region].sort((a, b) => b.rows.length - a.rows.length);
    });

    const container = document.getElementById("pelabuhanCardsContainer");
    container.innerHTML = "";

    // Render setiap region
    Object.entries(regionGroups).forEach(([regionName, zones]) => {
        if (zones.length === 0) return; // Skip empty regions

        // Create region section
        const regionSection = document.createElement("div");
        regionSection.className = "mb-8";

        // Region header
        const regionHeader = document.createElement("div");
        regionHeader.className = "flex items-center gap-3 mb-4 pb-2 border-b-2 border-gray-200";
        
        const regionIcon = document.createElement("span");
        regionIcon.className = "text-2xl";
        regionIcon.textContent = regionMapping[regionName]?.icon || '📍';
        
        const regionTitle = document.createElement("h3");
        regionTitle.className = "text-xl font-bold text-gray-800";
        regionTitle.textContent = regionName;
        
        const regionCount = document.createElement("span");
        regionCount.className = "text-sm bg-gray-100 px-3 py-1 rounded-full font-medium text-gray-600";
        const totalCount = zones.reduce((sum, {rows}) => sum + rows.length, 0);
        regionCount.textContent = `${zones.length} lokasi • ${totalCount} data`;
        
        regionHeader.appendChild(regionIcon);
        regionHeader.appendChild(regionTitle);
        regionHeader.appendChild(regionCount);
        
        // Cards grid for this region - reduce columns for better layout
        const cardsGrid = document.createElement("div");
        cardsGrid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full";

        // Render cards for this region
        zones.forEach(({zone, rows}, idx) => {
            const count = rows.length;
            const manualCount = rows.filter(r => !((r["no_pkk_inaportnet"] || "").trim())).length;
            let pct = 0;
            if (count > 0) pct = (manualCount / count) * 100;
            const pctText = (Math.abs(pct - Math.round(pct)) < 0.05) ? Math.round(pct).toString() : pct.toFixed(1);

            const dnCount = rows.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.DN")).length;
            const lnCount = rows.filter(r => (r["no_pkk_inaportnet"] || "").includes("PKK.LN")).length;

            const card = document.createElement("div");
            card.className = "bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition-all duration-300 border border-gray-200 group min-h-[160px]";
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <div class="w-10 h-10 bg-${regionName === 'Kalimantan' ? 'green' : regionName === 'Jawa' ? 'blue' : 'orange'}-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-${regionName === 'Kalimantan' ? 'green' : regionName === 'Jawa' ? 'blue' : 'orange'}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h3 class="font-bold text-gray-900 text-sm leading-tight break-words" title="${zone}">${zone}</h3>
                            <p class="text-xs text-gray-500">Pelabuhan</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div class="text-2xl font-bold text-gray-900">${count}</div>
                        <div class="text-xs text-gray-500 uppercase">TOTAL</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <div class="text-xs font-medium text-blue-700 mb-1">DN</div>
                        <div class="text-lg font-bold text-blue-900">${dnCount}</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <div class="text-xs font-medium text-green-700 mb-1">LN</div>
                        <div class="text-lg font-bold text-green-900">${lnCount}</div>
                    </div>
                </div>
                
                ${manualCount > 0 ? `
                <div class="mt-3 p-3 bg-red-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-red-700">Manual</span>
                        <span class="text-sm font-bold text-red-900">${manualCount} (${pctText}%)</span>
                    </div>
                </div>
                ` : ''}
            `;

            cardsGrid.appendChild(card);
        });

        regionSection.appendChild(regionHeader);
        regionSection.appendChild(cardsGrid);
        container.appendChild(regionSection);
    });
}

        // localStorage key for abai data
        const ABAI_STORAGE_KEY = 'outstanding_abai_data';

        // Function to get abai data from localStorage
        function getAbaiFromLocalStorage() {
            try {
                const stored = localStorage.getItem(ABAI_STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    console.log(`📱 Loaded ${data.length} entries from localStorage`);
                    return new Set(data);
                }
            } catch (e) {
                console.warn('Error reading from localStorage:', e);
            }
            return new Set();
        }

        // Function to save abai data to localStorage
        function saveAbaiToLocalStorage(abaiSet) {
            try {
                const data = Array.from(abaiSet);
                localStorage.setItem(ABAI_STORAGE_KEY, JSON.stringify(data));
                console.log(`💾 Saved ${data.length} entries to localStorage`);
            } catch (e) {
                console.warn('Error saving to localStorage:', e);
            }
        }

        // Function to add single item to localStorage
        function addToAbaiLocalStorage(noPkk) {
            const abaiSet = getAbaiFromLocalStorage();
            abaiSet.add(noPkk);
            saveAbaiToLocalStorage(abaiSet);
        }

        // Function to fetch persistent abai data with localStorage fallback
        async function fetchAbaiData() {
            let abaiSet = new Set();
            
            try {
                const apiUrl = getApiUrl();
                console.log('🔄 Fetching persistent abai data from:', apiUrl);
                
                // Try to get abai list from server first (GitHub integration)
                const response = await fetch(`${apiUrl}/abaikan?action=list`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('📊 Server abai data received:', result);
                    
                    if (result.abai_list && Array.isArray(result.abai_list) && result.abai_list.length > 0) {
                        result.abai_list.forEach(pkk => {
                            if (pkk && pkk.trim()) {
                                abaiSet.add(pkk.trim());
                            }
                        });
                        console.log(`✅ Loaded ${abaiSet.size} entries from server (${result.source})`);
                        
                        // Sync with localStorage for offline access
                        saveAbaiToLocalStorage(abaiSet);
                        return abaiSet;
                    } else if (!result.github_available) {
                        console.log('⚠️ GitHub not available, using localStorage for persistence');
                    }
                }
                
                // Fallback to localStorage (for production persistence)
                console.log('🔄 Using localStorage for persistent data...');
                abaiSet = getAbaiFromLocalStorage();
                
                if (abaiSet.size > 0) {
                    console.log(`📱 Using ${abaiSet.size} entries from localStorage persistence`);
                    return abaiSet;
                }
                
                // Final fallback to local abai.csv file (development only)
                console.log('⚠️ No persistent data found, trying local abai.csv...');
                const abaiText = await fetchCSV("abai.csv");
                if (abaiText) {
                    const lines = abaiText.split("\n").map(l => l.trim()).filter(Boolean);
                    if (lines.length) {
                        // Remove header line if it contains header name
                        if (/no_pkk_inaportnet/i.test(lines[0])) lines.shift();
                        lines.forEach(line => {
                            // support values separated by commas and extra commas/empty items
                            line.split(",").forEach(v => {
                                const t = (v || "").trim();
                                if (t) abaiSet.add(t);
                            });
                        });
                    }
                    console.log(`✅ Loaded ${abaiSet.size} entries from local abai.csv`);
                    
                    // Save to localStorage for future use
                    saveAbaiToLocalStorage(abaiSet);
                }
                
            } catch (e) {
                console.warn("Could not load abai data from server, using localStorage:", e);
                abaiSet = getAbaiFromLocalStorage();
            }
            
            return abaiSet;
        }

        async function main() {
            // Initialize GitHub connection icon
            updateGithubConnectionIcon('Loading...');
            
            const csvText = await fetchCSV("gabung.csv");
            if (!csvText) return;
            const { headers, data: rawData } = parseCSV(csvText);

            // Fetch persistent abai data
            const abaiSet = await fetchAbaiData();

            // Filter out rows whose no_pkk_inaportnet appears in abaiSet
            const filtered = rawData.filter(r => {
                const key = (r["no_pkk_inaportnet"] || "").trim();
                return !key || !abaiSet.has(key);
            });
            const removedCount = rawData.length - filtered.length;
            if (removedCount > 0) {
                console.info(`🗂️ Excluded ${removedCount} rows based on persistent abai data`);
                // Hidden: Data filter notification on page load
                // showNotification(`Data ter-filter: ${removedCount} baris diabaikan dari tampilan`, 'info', 3000);
            }

            globalHeaders = headers;
            globalData = filtered;

            renderPelabuhanCards(filtered);
            populateTable(headers, filtered);
            populatePelabuhanFilter(filtered);
            populateYearFilter(filtered);
            attachPelabuhanFilterListener();
            attachYearFilterListener();
            
            // Initialize and update chart
            initializeChart(filtered);
            updateChartStats(filtered);

            console.log('Dashboard initialized with chart');
         }

        // New: download gabung.csv by fetching as blob then triggering a download
        async function downloadGabung() {
            const btn = document.getElementById("downloadGabungBtn");
            if (btn) btn.disabled = true;
            try {
                // Try XLSX first
                try {
                    const resp = await fetch("gabung.xlsx", { cache: "no-store" });
                    if (!resp.ok) throw new Error("gabung.xlsx not available");
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "gabung.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1500);
                    return;
                } catch (errX) {
                    console.warn("gabung.xlsx not found, falling back to gabung.csv:", errX);
                }

                // Fallback to CSV
                const respCsv = await fetch("gabung.csv", { cache: "no-store" });
                if (!respCsv.ok) throw new Error("gabung.csv not available");
                const blobCsv = await respCsv.blob();
                const urlCsv = URL.createObjectURL(blobCsv);
                const aCsv = document.createElement("a");
                aCsv.href = urlCsv;
                aCsv.download = "gabung.csv";
                document.body.appendChild(aCsv);
                aCsv.click();
                aCsv.remove();
                setTimeout(() => URL.revokeObjectURL(urlCsv), 1500);
            } catch (err) {
                console.error("Download gabung failed:", err);
                alert("Gagal mendownload gabung.xlsx atau gabung.csv. Periksa file dan hak akses server.");
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        // PKK Clear Management Functions
        function loadPkkClearData() {
            console.log('🔄 Loading PKK Clear data...');
            updateIgnoredStats();
            loadIgnoredList();
            initPkkClearEventListeners();
        }

        async function updateIgnoredStats() {
            console.log('📊 Loading PKK Clear statistics...');
            
            // Get localStorage data
            const abaiSet = getAbaiFromLocalStorage();
            const localCount = abaiSet.size;
            
            // Update localStorage count immediately
            document.getElementById('localStorageCount').textContent = localCount;
            
            // Try to get GitHub data
            let githubCount = 0;
            let githubStatus = 'Loading...';
            
            try {
                console.log('🔄 Fetching GitHub data...');
                const apiUrl = getApiUrl();
                console.log('📡 API URL:', apiUrl);
                const response = await fetch(`${apiUrl}/abaikan?action=list`);
                
                console.log('📡 Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    githubCount = data.total_entries || 0;
                    githubStatus = data.source === 'github' ? 'Connected' : 
                                   data.source === 'github_error' ? 'GitHub Error' :
                                   data.source === 'fallback' ? 'Fallback Mode' : 
                                   'Unknown Status';
                    
                    console.log(`✅ GitHub API Response:`, {
                        entries: githubCount,
                        source: data.source,
                        success: data.success,
                        error: data.error,
                        debug: data.debug
                    });
                    
                    // Show detailed error if available
                    if (data.error) {
                        console.error('🚨 GitHub API Error Details:', data.error);
                        if (data.debug) {
                            console.error('🔍 Debug Info:', data.debug);
                        }
                    }
                } else {
                    console.log('⚠️ GitHub API not available, status:', response.status);
                    githubStatus = 'Not Available';
                }
            } catch (error) {
                console.error('❌ Error fetching GitHub data:', error);
                githubStatus = 'Connection Error';
            }
            
            // Update GitHub count and status
            document.getElementById('githubCount').textContent = githubCount;
            document.getElementById('githubStatus').textContent = githubStatus;
            
            // Show debug info if there are issues
            const debugElement = document.getElementById('githubDebug');
            if (githubStatus !== 'Connected' && githubStatus !== 'Loading...') {
                const apiUrl = getApiUrl();
                debugElement.textContent = `API: ${apiUrl}/abaikan`;
                debugElement.style.display = 'block';
            } else {
                debugElement.style.display = 'none';
            }
            
            // Update detailed display elements
            document.getElementById('githubEntriesDisplay').textContent = githubCount;
            document.getElementById('localEntriesDisplay').textContent = localCount;
            document.getElementById('githubConnectionStatus').textContent = githubStatus;
            
            // Calculate total unique entries
            const totalCount = Math.max(localCount, githubCount);
            document.getElementById('totalIgnoredCount').textContent = totalCount;
            
            // Determine primary storage type
            let storageType = 'localStorage';
            if (githubCount > 0 && githubStatus === 'Connected') {
                storageType = 'GitHub + localStorage';
            }
            
            // Update sync status indicator
            updateSyncStatusIndicator(localCount, githubCount, githubStatus);
            updateSyncSummary(localCount, githubCount, githubStatus);
            updateGithubConnectionIcon(githubStatus, githubCount);
            
            console.log(`📊 PKK Clear Stats - Local: ${localCount}, GitHub: ${githubCount}, Total: ${totalCount}`);
        }
        
        function updateSyncStatusIndicator(localCount, githubCount, githubStatus) {
            const syncIndicator = document.getElementById('syncStatusIndicator');
            const syncText = document.getElementById('syncStatusText');
            
            if (!syncIndicator || !syncText) return;
            
            if (githubStatus === 'Connected') {
                if (localCount === githubCount) {
                    syncIndicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    syncText.textContent = 'Synchronized';
                    syncText.className = 'text-green-600 text-sm font-medium';
                } else if (githubCount > localCount) {
                    syncIndicator.className = 'w-3 h-3 bg-blue-500 rounded-full animate-pulse';
                    syncText.textContent = 'GitHub has more data';
                    syncText.className = 'text-blue-600 text-sm font-medium';
                } else {
                    syncIndicator.className = 'w-3 h-3 bg-orange-500 rounded-full animate-pulse';
                    syncText.textContent = 'Local has more data';
                    syncText.className = 'text-orange-600 text-sm font-medium';
                }
            } else {
                syncIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                syncText.textContent = 'GitHub not available';
                syncText.className = 'text-red-600 text-sm font-medium';
            }
        }
        
        function updateSyncSummary(localCount, githubCount, githubStatus) {
            const summaryEl = document.getElementById('syncSummary');
            if (!summaryEl) return;
            
            let summary = '';
            if (githubStatus === 'Connected') {
                if (localCount === githubCount) {
                    summary = `✅ Data synchronized: ${localCount} entries in both GitHub and browser storage.`;
                } else if (githubCount > localCount) {
                    summary = `⬇️ GitHub has ${githubCount - localCount} more entries than local storage (${githubCount} vs ${localCount}).`;
                } else {
                    summary = `⬆️ Local storage has ${localCount - githubCount} more entries than GitHub (${localCount} vs ${githubCount}).`;
                }
            } else {
                summary = `❌ GitHub not available. Only local storage active with ${localCount} entries.`;
            }
            summaryEl.textContent = summary;
        }
        
        function updateGithubConnectionIcon(githubStatus, githubCount = 0) {
            const githubIcon = document.getElementById('githubIcon');
            const githubStatusText = document.getElementById('githubStatusText');
            const githubConnectionDot = document.getElementById('githubConnectionDot');
            
            if (!githubIcon || !githubStatusText || !githubConnectionDot) return;
            
            if (githubStatus === 'Connected') {
                // Connected - Green
                githubIcon.className = 'w-6 h-6 text-green-400 transition-colors duration-300';
                githubConnectionDot.className = 'w-3 h-3 bg-green-400 rounded-full';
                githubStatusText.textContent = `Connected (${githubCount})`;
            } else if (githubStatus === 'Loading...') {
                // Loading - Blue with animation
                githubIcon.className = 'w-6 h-6 text-blue-400 transition-colors duration-300';
                githubConnectionDot.className = 'w-3 h-3 bg-blue-400 rounded-full animate-pulse';
                githubStatusText.textContent = 'Connecting...';
            } else {
                // Disconnected/Error - Red
                githubIcon.className = 'w-6 h-6 text-red-400 transition-colors duration-300';
                githubConnectionDot.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
                githubStatusText.textContent = githubStatus === 'Not Available' ? 'Offline' : 'Error';
            }
        }
        
        async function syncLocalToGitHub() {
            const btn = document.getElementById('syncToGithubBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '🔄 Syncing...';
            
            try {
                showNotification('🔄 Starting sync to GitHub...', 'info');
                
                const abaiSet = getAbaiFromLocalStorage();
                const detailedKey = ABAI_STORAGE_KEY + '_detailed';
                const detailedData = JSON.parse(localStorage.getItem(detailedKey) || '[]');
                
                let syncCount = 0;
                for (const pkk of abaiSet) {
                    const detailed = detailedData.find(item => item.pkk === pkk);
                    const reasonData = {
                        reason: detailed?.reason || 'no_reason',
                        notes: detailed?.notes || 'Synced from localStorage',
                        timestamp: detailed?.timestamp || new Date().toISOString()
                    };
                    
                    // Send to GitHub via API
                    const apiUrl = getApiUrl();
                    const response = await fetch(`${apiUrl}/abaikan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            no_pkk_inaportnet: pkk,
                            reason: reasonData.reason,
                            notes: reasonData.notes,
                            timestamp: reasonData.timestamp
                        })
                    });
                    
                    if (response.ok) syncCount++;
                }
                
                showNotification(`✅ Synced ${syncCount} entries to GitHub`, 'success');
                updateIgnoredStats();
                
            } catch (error) {
                console.error('Sync to GitHub failed:', error);
                showNotification('❌ Failed to sync to GitHub', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function syncGitHubToLocal() {
            const btn = document.getElementById('syncFromGithubBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '🔄 Syncing...';
            
            try {
                showNotification('🔄 Starting sync from GitHub...', 'info');
                
                const apiUrl = getApiUrl();
                const response = await fetch(`${apiUrl}/abaikan?action=list`);
                
                if (response.ok) {
                    const data = await response.json();
                    const githubList = data.abai_list || [];
                    
                    // Update localStorage
                    const existingData = JSON.parse(localStorage.getItem(ABAI_STORAGE_KEY) || '[]');
                    const newEntries = githubList.filter(item => !existingData.includes(item));
                    
                    if (newEntries.length > 0) {
                        const updatedData = [...existingData, ...newEntries];
                        localStorage.setItem(ABAI_STORAGE_KEY, JSON.stringify(updatedData));
                        
                        showNotification(`✅ Synced ${newEntries.length} new entries from GitHub`, 'success');
                    } else {
                        showNotification('✅ Local storage is up to date with GitHub', 'success');
                    }
                    
                    updateIgnoredStats();
                    loadIgnoredList();
                } else {
                    throw new Error('Failed to fetch from GitHub');
                }
                
            } catch (error) {
                console.error('Sync from GitHub failed:', error);
                showNotification('❌ Failed to sync from GitHub', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function exportComparisonData() {
            try {
                showNotification('🔄 Preparing comparison export...', 'info');
                
                const abaiSet = getAbaiFromLocalStorage();
                const localData = Array.from(abaiSet);
                
                // Get GitHub data
                const apiUrl = getApiUrl();
                const response = await fetch(`${apiUrl}/abaikan?action=list`);
                const githubData = response.ok ? (await response.json()).abai_list || [] : [];
                
                // Create comparison CSV
                const allEntries = new Set([...localData, ...githubData]);
                const csvContent = 'PKK_NUMBER,IN_LOCAL_STORAGE,IN_GITHUB,SYNC_STATUS,DATE_EXPORTED\n' + 
                    Array.from(allEntries).map(pkk => {
                        const inLocal = localData.includes(pkk) ? 'YES' : 'NO';
                        const inGithub = githubData.includes(pkk) ? 'YES' : 'NO';
                        let syncStatus = 'SYNCED';
                        if (inLocal !== inGithub) {
                            syncStatus = inLocal === 'YES' ? 'LOCAL_ONLY' : 'GITHUB_ONLY';
                        }
                        return `"${pkk}","${inLocal}","${inGithub}","${syncStatus}","${new Date().toISOString()}"`;
                    }).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `pkk_sync_comparison_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`✅ Comparison data exported (${allEntries.size} entries)`, 'success');
                
            } catch (error) {
                console.error('Export comparison failed:', error);
                showNotification('❌ Failed to export comparison data', 'error');
            }
        }

        function loadIgnoredList() {
            const abaiSet = getAbaiFromLocalStorage();
            const ignoredItemsList = document.getElementById('ignoredItemsList');
            const emptyState = document.getElementById('emptyIgnoredState');
            
            // Get detailed data
            const detailedKey = ABAI_STORAGE_KEY + '_detailed';
            const detailedData = JSON.parse(localStorage.getItem(detailedKey) || '[]');
            
            if (abaiSet.size === 0) {
                ignoredItemsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            const items = Array.from(abaiSet);
            ignoredItemsList.innerHTML = items.map((pkkNumber, index) => {
                // Find detailed data for this PKK number
                const detailed = detailedData.find(item => item.pkk === pkkNumber);
                const portName = detailed?.port_name || 'Unknown Port';
                const reason = detailed?.reason ? getReasonDisplayText(detailed.reason) : 'No reason provided';
                const notes = detailed?.notes || '';
                const timestamp = detailed?.timestamp ? new Date(detailed.timestamp).toLocaleString('id-ID') : '';
                
                return `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 border-b border-gray-100">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                            <span class="text-red-600 font-semibold text-sm">${index + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-col space-y-1">
                                <p class="font-medium text-gray-900 truncate">${pkkNumber}</p>
                                <p class="text-sm text-blue-600 font-medium truncate">📍 ${portName}</p>
                                <p class="text-sm text-orange-600 truncate">📋 ${reason}</p>
                                ${notes ? `<p class="text-xs text-gray-500 truncate" title="${notes}">💬 ${notes}</p>` : ''}
                                ${timestamp ? `<p class="text-xs text-gray-400">${timestamp}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full whitespace-nowrap">
                            Diabaikan
                        </span>
                        <button onclick="restoreIgnoredItem('${pkkNumber}')" 
                                class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-colors" 
                                title="Restore item">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                        <button onclick="removeIgnoredItem('${pkkNumber}')" 
                                class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" 
                                title="Delete permanently" style="display: none;">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function initPkkClearEventListeners() {
            // Refresh button
            const refreshBtn = document.getElementById('refreshIgnoredBtn');
            if (refreshBtn) {
                refreshBtn.onclick = () => {
                    loadPkkClearData();
                    showNotification('✅ Data berhasil diperbarui', 'success');
                };
            }
            
            // Clear all button
            const clearAllBtn = document.getElementById('clearAllIgnoredBtn');
            if (clearAllBtn) {
                clearAllBtn.onclick = () => {
                    if (confirm('⚠️ Apakah Anda yakin ingin menghapus SEMUA data PKK yang diabaikan?\n\nTindakan ini tidak dapat dibatalkan!')) {
                        clearAllIgnoredItems();
                    }
                };
            }
            
            // Export button
            const exportBtn = document.getElementById('exportIgnoredBtn');
            if (exportBtn) {
                exportBtn.onclick = exportIgnoredData;
            }
            
            // Search functionality
            const searchInput = document.getElementById('searchIgnoredInput');
            const searchBtn = document.getElementById('searchIgnoredBtn');
            
            if (searchInput && searchBtn) {
                const performSearch = () => {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    filterIgnoredList(searchTerm);
                };
                
                searchBtn.onclick = performSearch;
                searchInput.onkeypress = (e) => {
                    if (e.key === 'Enter') performSearch();
                };
            }
        }

        function restoreIgnoredItem(pkkNumber) {
            if (confirm(`Apakah Anda yakin ingin mengembalikan PKK: ${pkkNumber}?\n\nItem ini akan muncul kembali di tabel utama.`)) {
                const abaiSet = getAbaiFromLocalStorage();
                abaiSet.delete(pkkNumber);
                saveAbaiToLocalStorage(abaiSet);
                
                loadPkkClearData();
                showNotification(`✅ PKK ${pkkNumber} berhasil dikembalikan`, 'success');
                
                // Refresh main data if on dashboard/tabel tab
                if (typeof refreshDataAfterAbaikan === 'function') {
                    refreshDataAfterAbaikan();
                }
            }
        }

        function removeIgnoredItem(pkkNumber) {
            if (confirm(`⚠️ Apakah Anda yakin ingin menghapus PKK: ${pkkNumber} secara PERMANEN?\n\nTindakan ini tidak dapat dibatalkan!`)) {
                const abaiSet = getAbaiFromLocalStorage();
                abaiSet.delete(pkkNumber);
                saveAbaiToLocalStorage(abaiSet);
                
                loadPkkClearData();
                showNotification(`🗑️ PKK ${pkkNumber} berhasil dihapus secara permanen`, 'warning');
            }
        }

        function clearAllIgnoredItems() {
            try {
                localStorage.removeItem(ABAI_STORAGE_KEY);
                loadPkkClearData();
                showNotification('🗑️ Semua data PKK yang diabaikan berhasil dihapus', 'warning');
                
                // Refresh main data if on dashboard/tabel tab
                if (typeof refreshDataAfterAbaikan === 'function') {
                    refreshDataAfterAbaikan();
                }
            } catch (error) {
                console.error('Error clearing ignored items:', error);
                showNotification('❌ Gagal menghapus data', 'error');
            }
        }

        function exportIgnoredData() {
            const abaiSet = getAbaiFromLocalStorage();
            
            if (abaiSet.size === 0) {
                showNotification('⚠️ Tidak ada data untuk diekspor', 'warning');
                return;
            }
            
            // Get detailed data
            const detailedKey = ABAI_STORAGE_KEY + '_detailed';
            const detailedData = JSON.parse(localStorage.getItem(detailedKey) || '[]');
            
            const data = Array.from(abaiSet);
            const csvContent = 'PKK_NUMBER,PORT_NAME,REASON,NOTES,TIMESTAMP,DATE_EXPORTED,STATUS\n' + 
                data.map(pkk => {
                    const detailed = detailedData.find(item => item.pkk === pkk);
                    const portName = (detailed?.port_name || 'Unknown Port').replace(/"/g, '""');
                    const reason = (detailed?.reason ? getReasonDisplayText(detailed.reason) : 'No reason').replace(/"/g, '""');
                    const notes = (detailed?.notes || '').replace(/"/g, '""');
                    const timestamp = detailed?.timestamp || '';
                    const dateExported = new Date().toISOString();
                    
                    return `"${pkk}","${portName}","${reason}","${notes}","${timestamp}","${dateExported}","IGNORED"`;
                }).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `pkk_ignored_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`✅ Data berhasil diekspor (${data.length} items)`, 'success');
        }

        function filterIgnoredList(searchTerm) {
            const abaiSet = getAbaiFromLocalStorage();
            const filteredItems = Array.from(abaiSet).filter(pkk => 
                pkk.toLowerCase().includes(searchTerm)
            );
            
            const ignoredItemsList = document.getElementById('ignoredItemsList');
            const emptyState = document.getElementById('emptyIgnoredState');
            
            if (filteredItems.length === 0) {
                ignoredItemsList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p class="text-gray-600">Tidak ditemukan hasil untuk: "${searchTerm}"</p>
                        <button onclick="loadIgnoredList()" class="mt-2 text-blue-600 hover:text-blue-800">Tampilkan semua</button>
                    </div>
                `;
                return;
            }
            
            ignoredItemsList.innerHTML = filteredItems.map((pkkNumber, index) => `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                            <span class="text-red-600 font-semibold text-sm">${index + 1}</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${pkkNumber}</p>
                            <p class="text-sm text-gray-500">PKK Number</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">
                            Diabaikan
                        </span>
                        <button onclick="restoreIgnoredItem('${pkkNumber}')" 
                                class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-colors" 
                                title="Restore item">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                        <button onclick="removeIgnoredItem('${pkkNumber}')" 
                                class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" 
                                title="Delete permanently" style="display: none;">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Global variables for modal
        let currentAbaiData = null;

        // Modal Management Functions
        function showAbaiReasonModal(noPkkInaportnet, buttonElement, rowElement, rowData = null) {
            console.log('🔧 DEBUG: showAbaiReasonModal called with:', {
                noPkkInaportnet,
                buttonElement,
                rowElement,
                rowData
            });
            
            // Store current data for later use with full row data
            currentAbaiData = {
                noPkkInaportnet: noPkkInaportnet,
                buttonElement: buttonElement,
                rowElement: rowElement,
                rowData: rowData
            };

            console.log('✅ DEBUG: currentAbaiData stored:', currentAbaiData);

            // Set PKK number in modal
            const modalPkk = document.getElementById('modalPkkNumber');
            if (modalPkk) {
                modalPkk.textContent = noPkkInaportnet;
                console.log('✅ DEBUG: Modal PKK number set');
            } else {
                console.error('❌ DEBUG: modalPkkNumber element not found');
            }
            
            // Reset form
            resetAbaiReasonForm();
            
            // Show modal
            const modal = document.getElementById('abaiReasonModal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('✅ DEBUG: Modal shown');
            } else {
                console.error('❌ DEBUG: abaiReasonModal element not found');
            }
        }

        function closeAbaiReasonModal() {
            console.log('🔧 DEBUG: closeAbaiReasonModal called, clearing currentAbaiData');
            
            // Hide modal
            document.getElementById('abaiReasonModal').classList.add('hidden');
            
            // Clear current data
            currentAbaiData = null;
            
            // Reset form
            resetAbaiReasonForm();
        }

        function resetAbaiReasonForm() {
            document.getElementById('abaiReasonSelect').value = '';
            document.getElementById('customReasonText').value = '';
            document.getElementById('additionalNotes').value = '';
            document.getElementById('customReasonDiv').classList.add('hidden');
        }

        function confirmAbaikanAction() {
            console.log('🔧 DEBUG: confirmAbaikanAction called');
            
            const reasonSelect = document.getElementById('abaiReasonSelect');
            const customReasonText = document.getElementById('customReasonText');
            const additionalNotes = document.getElementById('additionalNotes');

            console.log('🔧 DEBUG: Form elements:', {
                reasonValue: reasonSelect?.value,
                customText: customReasonText?.value,
                notes: additionalNotes?.value
            });

            // Validate reason selection
            if (!reasonSelect.value) {
                console.log('❌ DEBUG: No reason selected');
                showNotification('⚠️ Silakan pilih alasan terlebih dahulu', 'warning');
                return;
            }

            // Validate custom reason if selected
            if (reasonSelect.value === 'custom' && !customReasonText.value.trim()) {
                console.log('❌ DEBUG: Custom reason empty');
                showNotification('⚠️ Silakan masukkan alasan khusus', 'warning');
                return;
            }

            // Prepare reason data
            let finalReason = reasonSelect.value;
            if (reasonSelect.value === 'custom') {
                finalReason = customReasonText.value.trim();
            }

            const reasonData = {
                reason: finalReason,
                notes: additionalNotes.value.trim(),
                timestamp: new Date().toISOString()
            };

            console.log('✅ DEBUG: Reason data prepared:', reasonData);
            console.log('🔧 DEBUG: Current abai data:', currentAbaiData);

            // Proceed with abaikan action BEFORE closing modal
            if (currentAbaiData) {
                console.log('🚀 DEBUG: Calling handleAbaikanWithReason...');
                
                // Store data before closing modal
                const storedData = {
                    noPkkInaportnet: currentAbaiData.noPkkInaportnet,
                    buttonElement: currentAbaiData.buttonElement,
                    rowElement: currentAbaiData.rowElement,
                    rowData: currentAbaiData.rowData
                };
                
                // Close modal now
                closeAbaiReasonModal();
                
                // Call handler with stored data including row data
                handleAbaikanWithReason(
                    storedData.noPkkInaportnet,
                    storedData.buttonElement,
                    storedData.rowElement,
                    reasonData,
                    storedData.rowData
                );
            } else {
                console.error('❌ DEBUG: No currentAbaiData available!');
                showNotification('❌ Error: Data tidak tersedia, coba lagi', 'error');
                closeAbaiReasonModal(); // Close modal even on error
            }
        }

        // Event listener for reason selection change
        document.addEventListener('DOMContentLoaded', function() {
            const reasonSelect = document.getElementById('abaiReasonSelect');
            const customReasonDiv = document.getElementById('customReasonDiv');

            if (reasonSelect) {
                reasonSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customReasonDiv.classList.remove('hidden');
                        document.getElementById('customReasonText').focus();
                    } else {
                        customReasonDiv.classList.add('hidden');
                    }
                });
            }

            // Close modal when clicking outside
            document.getElementById('abaiReasonModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAbaiReasonModal();
                }
            });

            // Handle ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAbaiReasonModal();
                }
            });
        });

        main();
    </script>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <script>
        // Register Chart.js plugins
        Chart.register(ChartDataLabels);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <script>
  // Enforce session + 30-minute inactivity logout
  if (typeof enforceAuth === 'function') {
    enforceAuth();
  }
</script>

    <!-- Popup Modal untuk Alasan Abaikan -->
    <div id="abaiReasonModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <svg class="w-6 h-6 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Konfirmasi Abaikan Data
                    </h3>
                    <button onclick="closeAbaiReasonModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- PKK Info -->
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">PKK Number:</p>
                    <p id="modalPkkNumber" class="font-medium text-gray-900"></p>
                </div>

                <!-- Reason Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Pilih alasan mengapa data ini diabaikan:
                    </label>
                    <select id="abaiReasonSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Pilih Alasan --</option>
                        <option value="data_duplikat">Data Duplikat</option>
                        <option value="data_tidak_valid">Data Tidak Valid</option>
                        <option value="sudah_diproses">Sudah Diproses</option>
                        <option value="di_luar_jurisdiksi">Di Luar Jurisdiksi</option>
                        <option value="tidak_relevan">Tidak Relevan</option>
                        <option value="error_sistem">Error Sistem</option>
                        <option value="custom">Alasan Lainnya (Tulis Manual)</option>
                    </select>
                </div>

                <!-- Custom Reason Input -->
                <div id="customReasonDiv" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tulis alasan khusus:
                    </label>
                    <textarea id="customReasonText" 
                              placeholder="Masukkan alasan khusus mengapa data ini diabaikan..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                              rows="3"></textarea>
                </div>

                <!-- Additional Notes -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Catatan tambahan (opsional):
                    </label>
                    <textarea id="additionalNotes" 
                              placeholder="Tambahkan catatan jika diperlukan..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                              rows="2"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button onclick="closeAbaiReasonModal()" 
                            class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Batal
                    </button>
                    <button onclick="confirmAbaikanAction()" 
                            class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        OK - Abaikan
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
