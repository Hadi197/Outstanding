<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outstanding Wilayah 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        table {
            width: 100%;
        }
        table td, table th {
            font-size: 0.7rem;
        }
        #tableContainer thead th {
            text-align: center;
            vertical-align: middle;
        }

        /* Chart responsive: jangan melewati page, sejajar dengan tabel (.container) */
        .chart-wrapper {
            width: 100%;
            max-width: 100%; /* tetap dalam container */
            height: 300px;   /* tinggi tetap */
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 8px; /* beri sedikit padding agar tidak menempel ke tepi layar */
        }
        /* Pastikan canvas mengikuti lebar wrapper dan menjaga tinggi yang diinginkan */
        #barChart {
            width: 100% !important;
            height: 300px !important;
            display: block;
        }
        /* Untuk layar kecil, kecilkan tinggi agar tetap proporsional */
        @media (max-width: 576px) {
            .chart-wrapper { height: 220px; }
            #barChart { height: 220px !important; }
        }

        /* Hide the chart title */
        #chartTitle { display: none !important; }

        /* Cards panel & card design (updated for proportional layout) */
        .cards-panel {
            background: rgba(255,255,255,0.95); /* near-white panel */
            border: 1px solid rgba(15,40,55,0.06);
            color: #0b2b3a;
            box-shadow: 0 8px 20px rgba(10,20,30,0.06);
            border-radius: 18px;
            padding: 18px;
            backdrop-filter: none;
            margin-bottom: 12px;
        }

        /* Ensure card text is readable on light background */
        .stat-title, .stat-value {
            color: #062431; /* dark blue/teal */
        }

        /* Table adjustments for light background */
        .table {
            background-color: transparent;
            color: #062431;
        }
        .table thead th {
            background-color: rgba(255,255,255,0.85) !important;
            color: #062431 !important;
        }
        .table tbody td {
            background-color: rgba(255,255,255,0.95);
            color: #062431;
        }

        /* Grid layout: responsive columns that stay proportional */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            align-items: stretch;
        }

        .stat-card {
            min-height: 120px;           /* uniform height */
            padding: 16px 18px;
            border-radius: 12px;
            color: #fff;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 8px 20px rgba(20,30,50,0.06);
            transition: transform .18s ease, box-shadow .18s ease;
        }
        .stat-card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(20,30,50,0.12); }

        /* Title left, value right (updated for responsive sizes & wrapping) */
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }
        .stat-title {
            /* single-line title: no wrapping, truncate with ellipsis */
            font-size: clamp(0.55rem, 0.8vw, 0.70rem);
            font-weight: 700;
            opacity: 0.95;
            max-width: 100%;
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            line-height: 1.1;
        }
        .stat-value {
            /* smaller numeric value for compact card layout */
            font-size: clamp(0.95rem, 2.2vw, 1.4rem);
            font-weight: 900;
            line-height: 1;
            text-align: right;
            white-space: nowrap;
            min-width: 2.6em; /* keep enough space for number */
        }

        /* decorative circle positioned bottom-right for subtle effect */
        .stat-card .card-circle {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            right: -30px;
            bottom: -30px;
            opacity: 0.12;
            filter: blur(8px);
            pointer-events: none;
        }

        /* sample gradient presets (used inline as style in JS) */
        /* responsive adjustments */
        @media (max-width: 600px) {
            .stat-card { min-height: 100px; padding: 12px; }
            /* smaller value on mobile */
            .stat-value { font-size: clamp(0.85rem, 4.2vw, 1.2rem); }
            /* make mobile title even smaller */
            .stat-title { font-size: clamp(0.5rem, 2.2vw, 0.66rem); }
        }

        /* Hide the specific filter labels */
        label[for="pelabuhanFilter"],
        label[for="yearFilter"] {
            display: none !important;
        }

        /* Page light-blue background + default foreground color */
        body {
            background-color: #e6f7ff; /* light blue */
            color: #0b2b3a; /* dark text for readability */
        }

		/* Neo button asset: neon/glass button with improved contrast */
		.neo-button {
			--bg: linear-gradient(90deg,#075985 0%, #0b6fb3 60%); /* darker */
			--glow: rgba(11,111,179,0.28);
			display: inline-block;
			padding: 8px 14px;
			font-weight: 800;
			font-size: 0.9rem;
			color: #ffffff;
			background: var(--bg);
			border: 1px solid rgba(4,30,60,0.12);
			border-radius: 10px;
			position: relative;
			cursor: pointer;
			overflow: hidden;
			transition: transform .12s ease, box-shadow .18s ease;
			box-shadow: 0 10px 30px rgba(4,30,60,0.18), 0 0 28px rgba(11,111,179,0.10) inset;
			text-shadow: 0 1px 2px rgba(2,10,18,0.45);
		}
		.neo-button:focus { outline: none; box-shadow: 0 12px 36px var(--glow); transform: translateY(-1px); }
		.neo-button:hover { transform: translateY(-3px); box-shadow: 0 18px 46px var(--glow); }

		/* animated sheen â€” reduce intensity so it won't wash text */
		.neo-button::before {
			content: "";
			position: absolute;
			top: -40%;
			left: -40%;
			width: 40%;
			height: 180%;
			background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.32) 50%, rgba(255,255,255,0) 100%);
			transform: rotate(-25deg);
			opacity: 0.6;
			transition: none;
			animation: sheen 3.2s linear infinite;
			pointer-events: none;
		}
		@keyframes sheen {
			0% { left: -40%; opacity: 0; }
			10% { opacity: 0.9; }
			50% { left: 120%; opacity: 0.6; }
			90% { opacity: 0; }
			100% { left: 120%; opacity: 0; }
		}

		/* small inner highlight (bottom edge) */
		.neo-button::after {
			content: "";
			position: absolute;
			left: 0;
			right: 0;
			bottom: 0;
			height: 6px;
			background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0));
			pointer-events: none;
			border-bottom-left-radius: 10px;
			border-bottom-right-radius: 10px;
			opacity: 0.85;
		}

		/* accessible reduced motion */
		@media (prefers-reduced-motion: reduce) {
			.neo-button::before { animation: none; opacity: 0.35; }
		}

		/* Brighter neo-select: white / very-light-blue, dark text, subtle inner highlight */
		.neo-select {
			--bg: linear-gradient(180deg,#ffffff 0%, #f2fbff 60%);
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: none;
			background: var(--bg);
			color: #062431; /* dark text for readability */
			border: 1px solid rgba(6,36,49,0.10);
			padding: 8px 40px 8px 12px;
			border-radius: 10px;
			font-weight: 700;
			font-size: 0.9rem;
			box-shadow: 0 6px 18px rgba(6,36,49,0.04), inset 0 1px 0 rgba(255,255,255,0.8);
			/* dark arrow */
			background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="10" viewBox="0 0 24 24"><path fill="%23062231" d="M7 10l5 5 5-5z"/></svg>');
			background-repeat: no-repeat;
			background-position: right 12px center;
			cursor: pointer;
		}
		.neo-select:hover {
			box-shadow: 0 8px 22px rgba(6,36,49,0.06), inset 0 1px 0 rgba(255,255,255,0.85);
			transform: translateY(-1px);
		}
		.neo-select:focus {
			outline: none;
			box-shadow: 0 10px 30px rgba(6,36,49,0.10);
			transform: translateY(-1px);
		}

		@media (max-width: 576px) {
			.neo-select { font-size: 0.82rem; padding: 7px 34px 7px 8px; }
		}

		/* keep default "ALL" option readable */
		#pelabuhanFilter option[value="ALL"],
		#yearFilter option[value="ALL"],
		.neo-select option[value="ALL"] {
			color: #333333 !important;
		}

		/* wrapper to allow animated ring around select (select pseudo-elems unreliable) */
		.neo-select-wrap {
			position: relative;
			display: inline-block;
			border-radius: 12px;
			padding: 2px; /* space for animated ring */
			/* ensure wrapper doesn't affect layout too much */
			vertical-align: middle;
		}

		/* animated light ring (subtle) */
		.neo-select-wrap::before {
			content: "";
			position: absolute;
			inset: 0;               /* cover wrapper area */
			border-radius: 14px;    /* slightly larger than select */
			pointer-events: none;
			opacity: 0;             /* shown only on hover/focus-within */
			background: linear-gradient(90deg,
				rgba(255,255,255,0) 0%,
				rgba(255,255,255,0.75) 45%,
				rgba(255,255,255,0) 100%);
			filter: blur(8px);
			transform: translateX(-120%);
		}

		/* run sweep continuously but visible only on hover/focus */
		.neo-select-wrap:focus-within::before,
		.neo-select-wrap:hover::before {
			opacity: 1;
			animation: lightSweep 2.6s linear infinite;
		}

		@keyframes lightSweep {
			0%   { transform: translateX(-120%); }
			50%  { transform: translateX(20%); }
			100% { transform: translateX(120%); }
		}

		/* subtle static ring as border accent (low opacity) */
		.neo-select-wrap::after {
			content: "";
			position: absolute;
			inset: 0;
			border-radius: 14px;
			pointer-events: none;
			box-shadow: 0 0 0 1px rgba(6,36,49,0.06) inset;
		}

		/* ensure the select stays above the ring */
		.neo-select {
			position: relative;
			z-index: 2;
			border-radius: 10px;
		}

		/* Chart card: container around chart with soft shadow and rounded corners */
		.chart-card {
			background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,255,0.98));
			border-radius: 16px;
			padding: 12px;
			box-shadow: 0 18px 40px rgba(12,40,70,0.08), 0 6px 20px rgba(6,36,49,0.04) inset;
			margin: 0 auto;
			max-width: 100%;
			/* keep layout consistent with container */
			box-sizing: border-box;
		}

		/* make canvas pop a bit */
		.chart-card #barChart {
			border-radius: 10px;
			box-shadow: 0 8px 28px rgba(6,36,49,0.06);
			background: transparent;
			display: block;
		}

		/* New header banner (curved gradients like sample) */
		.page-header {
			position: relative;
			width: 100%;
			height: 92px;         /* smaller, more proportional */
			max-height: 14vh;
			min-height: 72px;
			margin: 8px 0 14px;
			overflow: visible;
			display: flex;
			align-items: center;
			justify-content: center;
			background: transparent;
		}
		.page-header .header-ribbon {
			position: absolute;
			left: 6%;
			right: 6%;
			top: 8px;
			bottom: 8px;
			border-radius: 28px;
			overflow: visible;
			display: block;
			/* subtle shadow like sample */
			box-shadow: 0 12px 22px rgba(6,36,49,0.06), 0 5px 10px rgba(6,36,49,0.03) inset;
		}
		/* center blue ribbon */
		.page-header .ribbon-center {
			position: absolute;
			left: 13%;
			right: 22%;
			top: 8px;
			bottom: 10px;
			border-radius: 22px;
			background: linear-gradient(90deg,#60bffb 0%, #49c6f6 40%, #2db6ff 70%, #8fd9ff 100%);
			box-shadow: inset 0 -12px 36px rgba(0,0,0,0.03);
			transform: skewX(-6deg);
		}
		/* left purple cap */
		.page-header .ribbon-left {
			position: absolute;
			left: 4%;
			width: 20%;
			top: 2%;
			bottom: 2%;
			border-radius: 22px;
			background: linear-gradient(135deg,#8e3dbf 0%, #d05aa9 60%);
			transform: translateX(-6%) skewX(-6deg);
			box-shadow: inset 0 -14px 30px rgba(0,0,0,0.03);
		}
		/* right magenta cap */
		.page-header .ribbon-right {
			position: absolute;
			right: 4%;
			width: 24%;
			top: 2%;
			bottom: 2%;
			border-radius: 22px;
			background: linear-gradient(135deg,#a13399 0%, #ff7bbf 60%);
			transform: translateX(6%) skewX(-6deg);
			box-shadow: inset 0 -14px 30px rgba(0,0,0,0.03);
		}
		.page-header .header-accent {
			position: absolute;
			left: 8%;
			right: 8%;
			top: 6px;
			bottom: 12px;
			pointer-events: none;
			border-radius: 28px;
			/* thin white outline highlight */
			box-shadow: 0 0 0 4px rgba(255,255,255,0.02) inset;
		}
		.page-header .header-title {
			position: relative;
			z-index: 40;
			font-weight: 900;
			letter-spacing: .06em;
			text-transform: uppercase;
			font-size: clamp(1.2rem, 3.2vw, 2.2rem); /* reduced */
			color: white;
			-webkit-text-stroke: 0.5px rgba(0,0,0,0.06);
			text-shadow: 0 5px 12px rgba(0,0,0,0.14);
			font-family: 'Arial Black', Arial, sans-serif;
			padding: 8px 18px;
			white-space: nowrap;           /* keep header on one line */
			overflow: hidden;
			text-overflow: ellipsis;
		}
		/* small decorative curve overlay */
		.page-header::before {
			content: "";
			position: absolute;
			left: 2%;
			right: 2%;
			bottom: -6px;
			height: 12px;
			border-radius: 50%;
			background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.00));
			filter: blur(5px);
			opacity: 0.6;
			z-index: 1;
		}

		@media (max-width: 576px) {
			.page-header { height: 78px; margin: 6px 0 10px; }
			.page-header .ribbon-left { width: 28%; left: 2%; }
			.page-header .ribbon-right { width: 34%; right: 2%; }
			.page-header .ribbon-center { left: 18%; right: 28%; }
			.cards-section-title { display:none; } /* kept for legacy if present */
			.page-header .header-title { font-size: clamp(1.0rem, 5.0vw, 1.6rem); padding: 6px 12px; }
		}

		/* Chart hero: decorative background left/right with diagonal pattern */
		.chart-hero {
			position: relative;
			background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,255,0.98));
			padding: 28px 0;
			overflow: visible;
		}
		/* Center inner area that keeps chart content readable */
		.chart-hero .chart-inner {
			position: relative;
			max-width: 1200px;
			margin: 0 auto;
			padding: 8px 20px;
			box-sizing: border-box;
		}

		/* Decorative left / right panels using diagonal repeating gradients */
		.chart-hero::before,
		.chart-hero::after {
			content: "";
			position: absolute;
			top: 0;
			bottom: 0;
			width: 36%;
			pointer-events: none;
			opacity: 0.92;
			z-index: 0;
		}
		.chart-hero::before {
			left: 0;
			background:
				repeating-linear-gradient(135deg,
					rgba(29, 186, 183, 0.12) 0 36px,
					rgba(255,255,255,0) 36px 72px),
				linear-gradient(135deg, rgba(29,186,183,0.06), rgba(29,186,183,0.02));
			transform-origin: left center;
		}
		.chart-hero::after {
			right: 0;
			background:
				repeating-linear-gradient(225deg,
					rgba(122, 61, 160, 0.10) 0 36px,
					rgba(255,255,255,0) 36px 72px),
				linear-gradient(225deg, rgba(122,61,160,0.04), rgba(122,61,160,0.01));
			transform-origin: right center;
		}
		/* Make the chart-card stand above decorative panels */
		.chart-hero .chart-card {
			position: relative;
			z-index: 10;
			/* slightly lifted look */
			margin: 0 auto;
			box-shadow: 0 20px 40px rgba(6,36,49,0.06);
		}

		/* Responsive tweaks so patterns don't crowd small screens */
		@media (max-width: 900px) {
			.chart-hero::before,
			.chart-hero::after { width: 28%; }
		}
		@media (max-width: 576px) {
			.chart-hero::before,
			.chart-hero::after { width: 20%; opacity: 0.9; }
			.chart-hero { padding: 18px 0; }
		}

		/* PKK Manual small label for cards */
		.pkk-manual {
			font-size: 0.78rem;
			font-weight: 800;
			margin-top: 6px;
			color: rgba(255,255,255,0.95); /* white-on-gradient for visibility */
			text-shadow: 0 3px 10px rgba(0,0,0,0.12);
			letter-spacing: 0.02em;
		}

		/* If card background is light/dark make a fallback darker label */
		.stat-card.light .pkk-manual {
			color: rgba(6,36,49,0.9);
			text-shadow: none;
		}

    </style>
</head>
<body>
    <!-- New decorative header (approximation of provided sample) -->
    <header class="page-header" role="banner" aria-label="Header banner">
        <span class="header-ribbon" aria-hidden="true">
            <span class="ribbon-left"></span>
            <span class="ribbon-center"></span>
            <span class="ribbon-right"></span>
            <span class="header-accent"></span>
        </span>
        <div class="header-title">OUTSTANDING WILAYAH 3</div>
    </header>

    <div class="container mb-4">
	<div class="cards-panel">
		<div id="pelabuhanCardsRow" class="cards-grid"></div>
	</div>
</div>

    <!-- Chart section with decorative diagonal panels -->
    <section class="chart-hero" aria-label="Chart banner">
        <div class="chart-inner">
            <h5 id="chartTitle" class="text-center" style="position:relative; z-index:12; margin-bottom:8px;">Departures per Month</h5>
            <div class="chart-card">
                <div class="chart-wrapper">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <div class="container mb-3 d-flex align-items-end" style="gap:8px;">
	<div>
		<label for="pelabuhanFilter" class="form-label">Filter by Pelabuhan:</label>
		<div class="neo-select-wrap" style="width:auto; display:inline-block;">
			<select id="pelabuhanFilter" class="form-select form-select-sm neo-select" style="width: auto;">
				<option value="ALL">Semua Pelabuhan</option>
			</select>
		</div>
	</div>
	<div>
		<label for="yearFilter" class="form-label">Filter by Tahun:</label>
		<div class="neo-select-wrap" style="width:auto; display:inline-block;">
			<select id="yearFilter" class="form-select form-select-sm neo-select" style="width: auto;">
				<option value="ALL">Semua Tahun</option>
			</select>
		</div>
	</div>
	<div class="ms-auto" style="display:flex; gap:8px; align-items:center;">
		<button id="downloadGabungBtn" class="neo-button" type="button">Download Data</button>
		<button id="clearFilterBtn" class="neo-button" type="button">Clear Filter</button>
	</div>
</div>

    <div class="container mb-5" id="tableContainer">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr id="table-header">
                    <!-- Table headers will be dynamically inserted here -->
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Table rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        async function fetchCSV(filePath) {
            try {
                const response = await fetch(filePath);
                const data = await response.text();
                return data;
            } catch (error) {
                console.error("Failed to fetch CSV file:", error);
                return null;
            }
        }

        function parseCSV(csvText) {
            const rows = csvText.split("\n").filter(row => row.trim() !== "");
            const headers = rows[0].split(",");
            const data = rows.slice(1).map(row => {
                const values = [];
                let current = "";
                let insideQuotes = false;

                for (let char of row) {
                    if (char === '"' && insideQuotes) {
                        insideQuotes = false;
                    } else if (char === '"' && !insideQuotes) {
                        insideQuotes = true;
                    } else if (char === "," && !insideQuotes) {
                        values.push(current.trim());
                        current = "";
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                return headers.reduce((acc, header, index) => {
                    acc[header] = values[index] ? values[index].replace(/^"|"$/g, "") : "";
                    return acc;
                }, {});
            });
            return { headers, data };
        }

        // Mapping label header tampilan -> field asli
        const HEADER_MAP = {
            no_pkk: "PKK",
            no_pkk_inaportnet: "PKK INAPORTNET",
            nomor_spb: "SPB",
            no_pkk_spb: "NO PKK",          // <-- added
            company_name: "AGEN",          // <-- added
            departure_date: "KEBERANGKATAN", // <-- added
            name_process_code: "STATUS",
            gt: "GRT",
            loa: "LOA",
            waktu_tolak: "TGL/JAM",
            vessel_name: "NAMA KAPAL",
            NO: "NO",
            PELABUHAN: "PELABUHAN",
            PELAYARAN: "PELAYARAN"
        };

        function populateTable(headers, data) {
            const tableHeader = document.getElementById("table-header");
            const tableBody = document.getElementById("table-body");

            // Clear existing table content
            tableHeader.innerHTML = "";
            tableBody.innerHTML = "";

            // Sembunyikan kolom name_branch (diganti PELABUHAN), no_pkk_wasop, dan waktu_tolak (TGL/JAM)
            const hiddenCols = new Set(["name_branch", "no_pkk_wasop", "waktu_tolak"]);
            const updatedHeaders = [
                "NO",
                ...headers.filter(h => !hiddenCols.has(h)),
                "PELABUHAN",
                "PELAYARAN"
            ];

            // Populate table headers (pakai label tampilan)
            updatedHeaders.forEach(header => {
                const th = document.createElement("th");
                th.textContent = HEADER_MAP[header] || header;
                tableHeader.appendChild(th);
            });

            // Populate table rows (tetap pakai key asli untuk ambil data)
            data.forEach((row, index) => {
                const tr = document.createElement("tr");
                updatedHeaders.forEach(header => {
                    const td = document.createElement("td");
                    if (header === "NO") {
                        td.textContent = index + 1;
                    } else if (header === "PELABUHAN") {
                        td.textContent = row["name_branch"] || "";
                    } else if (header === "PELAYARAN") {
                        if (row["no_pkk_inaportnet"]?.includes("PKK.DN")) td.textContent = "Dalam Negeri";
                        else if (row["no_pkk_inaportnet"]?.includes("PKK.LN")) td.textContent = "Luar Negeri";
                        else td.textContent = "";
                    } else {
                        td.textContent = row[header] || "";
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function aggregateByMonth(data) {
            const monthCounts = {};
            data.forEach(row => {
                const departureDate = row["departure_date"];
                if (!departureDate) return;

                const monthKey = departureDate.slice(0, 7); // Extract YYYY-MM format
                monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
            });

            const labels = Object.keys(monthCounts).sort();
            const values = labels.map(label => monthCounts[label]);
            return { labels, values };
        }

        let selectedMonth = null;

        function buildBarChart(ctx, labels, values) {
	const baseColors = [
		"#e57373", "#ba68c8", "#7986cb", "#64b5f6", "#4dd0e1", "#81c784", "#ffd54f", "#ffb74d", "#2f4b7c"
	];

	const maxVal = Math.max(...values, 1);
	const ghostValues = labels.map(() => Math.ceil(maxVal * 1.6)); // tall translucent background bars

	const chart = new Chart(ctx, {
		type: "bar",
		data: {
			labels: labels,
			datasets: [
				// Ghost background columns
				{
					label: "ghost",
					data: ghostValues,
					// will be drawn full-width but translucent
					backgroundColor: function(c) {
						const chart = c.chart;
						const {ctx, chartArea} = chart;
						if (!chartArea) return "rgba(150,150,200,0.08)";
						const grad = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
						grad.addColorStop(0, "rgba(200,220,240,0.22)");
						grad.addColorStop(1, "rgba(200,220,240,0.06)");
						return grad;
					},
					borderWidth: 0,
					barPercentage: 1.0,
					categoryPercentage: 0.92,
					borderSkipped: false,
					// rounded top effect (large radius)
					borderRadius: 100
				},
				// Foreground pill columns (actual values)
				{
					label: "Jumlah Keberangkatan",
					data: values,
					backgroundColor: function(c) {
						const chart = c.chart;
						const {ctx, chartArea} = chart;
						const idx = c.dataIndex;
						const color = baseColors[idx % baseColors.length];
						if (!chartArea) return color;
						const grad = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
						grad.addColorStop(0, color);
						grad.addColorStop(1, "rgba(255,255,255,0.18)");
						return grad;
					},
					borderColor: function(c) {
						const idx = c.dataIndex;
						return baseColors[idx % baseColors.length];
					},
					borderWidth: 0,
					// make pill narrow and rounded
					barPercentage: 0.34,
					categoryPercentage: 0.5,
					borderRadius: 40,
					borderSkipped: false
				}
			]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			layout: { padding: { top: 28, bottom: 10, left: 10, right: 10 } },
			plugins: {
				legend: { display: false },
				title: {
					display: true,
					text: "Chart Semua Unit",
					align: "center",
					font: { size: 18, weight: "700" }
				},
				datalabels: {
					// Show circular white label only for foreground dataset (datasetIndex === 1)
					display: function(ctx) { return ctx.datasetIndex === 1; },
					anchor: 'end',
					align: 'center',
					offset: -28, // place above pill
					backgroundColor: function(ctx) {
						return '#ffffff';
					},
					borderColor: function(ctx) {
						// colored ring matching pill
						const idx = ctx.dataIndex;
						return baseColors[idx % baseColors.length];
					},
					borderWidth: 4,
					borderRadius: 999,
					color: function(ctx) {
						const idx = ctx.dataIndex;
						return baseColors[idx % baseColors.length];
					},
					font: { weight: '700', size: 12 },
					padding: { top: 6, bottom: 6, left: 8, right: 8 },
					formatter: function(value) { return value; }
				}
			},
			scales: {
				x: {
					grid: {
						color: "rgba(15,30,40,0.06)"
					},
					ticks: {
						color: "#062431",
						maxRotation: 90,
						minRotation: 90
					},
					title: {
						display: true,
						text: "Month",
						color: "#062431"
					}
				},
				y: {
					beginAtZero: true,
					grid: { color: "rgba(15,30,40,0.06)" },
					ticks: { color: "#062431" },
					title: { display: true, text: "Value", color: "#062431" }
				}
			},
			// clicking behavior preserved from previous implementation
			onClick: function(evt, elements) {
				const chart = this;
				if (elements.length) {
					const idx = elements[0].index;
					const month = chart.data.labels[idx];
					selectedMonth = month;
					filterTableByPelabuhan(globalData, document.getElementById("pelabuhanFilter").value, month);
				} else {
					selectedMonth = null;
					filterTableByPelabuhan(globalData, document.getElementById("pelabuhanFilter").value);
				}
			}
		},
		plugins: [ChartDataLabels]
	});

	return chart;
}

        let globalData = [];
        let globalHeaders = [];
        let barChart;

        function populatePelabuhanFilter(data) {
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) {
                    pelabuhanKey = "name_branch";
                } else {
                    pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
                }
            }
            const pelabuhanSet = new Set(data.map(row => row[pelabuhanKey]).filter(Boolean));
            const pelabuhanFilter = document.getElementById("pelabuhanFilter");

            pelabuhanFilter.innerHTML = '<option value="ALL">Semua Pelabuhan</option>';

            pelabuhanSet.forEach(pelabuhan => {
                const option = document.createElement("option");
                option.value = pelabuhan;
                option.textContent = pelabuhan;
                pelabuhanFilter.appendChild(option);
            });
        }

        // Populate year combobox from departure_date (unique years)
        function populateYearFilter(data) {
		const years = new Set();
		data.forEach(row => {
			const d = row["departure_date"];
			if (d && d.length >= 4) years.add(d.slice(0, 4));
		});
		const yearFilter = document.getElementById("yearFilter");
		yearFilter.innerHTML = '<option value="ALL">Semua Tahun</option>';
		Array.from(years).sort().forEach(y => {
			const opt = document.createElement("option");
			opt.value = y;
			opt.textContent = y;
			yearFilter.appendChild(opt);
		});
	}

        // Unified filter: pelabuhan + year (+ optional month)
        function filterByPelabuhanAndYear() {
            const pelabuhan = document.getElementById("pelabuhanFilter").value || "ALL";
            const year = document.getElementById("yearFilter") ? document.getElementById("yearFilter").value : "ALL";
            let pelabuhanKey = "PELABUHAN";
            if (!globalHeaders.includes("PELABUHAN")) {
                if (globalHeaders.includes("name_branch")) pelabuhanKey = "name_branch";
                else pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
            }

            let filtered = globalData.slice();

            if (pelabuhan !== "ALL") filtered = filtered.filter(r => (r[pelabuhanKey] || "") === pelabuhan);
            if (year !== "ALL") filtered = filtered.filter(r => (r["departure_date"] || "").startsWith(year));
            if (selectedMonth) filtered = filtered.filter(r => (r["departure_date"] || "").slice(0,7) === selectedMonth);

            populateTable(globalHeaders, filtered);
            updateBarChart(filtered);
        }

        function clearAllFilters() {
            // Reset combobox
            document.getElementById("pelabuhanFilter").value = "ALL";
            document.getElementById("yearFilter").value = "ALL";
            // Reset selected month
            selectedMonth = null;
            // Show all data in table and chart
            populateTable(globalHeaders, globalData);
            updateBarChart(globalData);
        }

        // Update attachPelabuhanFilterListener to use unified filter
        function attachPelabuhanFilterListener() {
            const pelabuhanFilter = document.getElementById("pelabuhanFilter");
            pelabuhanFilter.addEventListener("change", () => {
                selectedMonth = null;
                filterByPelabuhanAndYear();
            });

            // Tambahkan event listener untuk tombol clear filter
            document.getElementById("clearFilterBtn").addEventListener("click", clearAllFilters);

            // New: download gabung.csv button
            const dlGabung = document.getElementById("downloadGabungBtn");
            if (dlGabung) dlGabung.addEventListener("click", downloadGabung);
        }

        // Year filter listener
        function attachYearFilterListener() {
		const yearFilter = document.getElementById("yearFilter");
		yearFilter.addEventListener("change", () => {
			selectedMonth = null;
			filterByPelabuhanAndYear();
		});
	}

        function updateBarChart(filteredData) {
            const { labels, values } = aggregateByMonth(filteredData);
            if (!barChart) return;

            // Update labels
            barChart.data.labels = labels;

            // ghost dataset should be larger than max to create background columns
            const maxVal = Math.max(...values, 1);
            const ghostValues = labels.map(() => Math.ceil(maxVal * 1.25));

            if (barChart.data.datasets && barChart.data.datasets.length >= 2) {
                // dataset[0] = ghost/background, dataset[1] = foreground actual values
                barChart.data.datasets[0].data = ghostValues;
                barChart.data.datasets[1].data = values;
            } else if (barChart.data.datasets && barChart.data.datasets.length === 1) {
                // fallback: single dataset present
                barChart.data.datasets[0].data = values;
            }

            barChart.update();
        }

        /* Updated renderPelabuhanCards: append stat-card directly into grid, show PKK Manual count with percentage */
function renderPelabuhanCards(data) {
	let pelabuhanKey = "PELABUHAN";
	if (!globalHeaders.includes("PELABUHAN")) {
		if (globalHeaders.includes("name_branch")) pelabuhanKey = "name_branch";
		else pelabuhanKey = globalHeaders.find(h => h.toLowerCase().includes("pelabuhan")) || globalHeaders[0];
	}

	// Count total and PKK-manual (empty no_pkk_inaportnet) per pelabuhan
	const pelabuhanCounts = {};
	const manualCounts = {};
	data.forEach(row => {
		const key = row[pelabuhanKey] || "Unknown";
		if (!pelabuhanCounts[key]) pelabuhanCounts[key] = 0;
		pelabuhanCounts[key] += 1;

		const pkk = (row["no_pkk_inaportnet"] || "").trim();
		if (!pkk) {
			manualCounts[key] = (manualCounts[key] || 0) + 1;
		}
	});

	const colors = [
		{bg: "linear-gradient(135deg,#ff7e7e,#ffb199)", circle: "rgba(255,255,255,0.18)"},
		{bg: "linear-gradient(135deg,#6a9bff,#8dc2ff)", circle: "rgba(255,255,255,0.16)"},
		{bg: "linear-gradient(135deg,#7fe7c9,#4fbfa6)", circle: "rgba(255,255,255,0.14)"},
		{bg: "linear-gradient(135deg,#7fd3ff,#5aa4ff)", circle: "rgba(255,255,255,0.12)"},
		{bg: "linear-gradient(135deg,#c8a3ff,#ff80bf)", circle: "rgba(255,255,255,0.14)"},
		{bg: "linear-gradient(135deg,#ffd56b,#ff8a5b)", circle: "rgba(255,255,255,0.12)"},
		{bg: "linear-gradient(135deg,#b089ff,#6ae0ff)", circle: "rgba(255,255,255,0.10)"}
	];

	const rowDiv = document.getElementById("pelabuhanCardsRow");
	rowDiv.innerHTML = "";

	Object.entries(pelabuhanCounts).forEach(([pelabuhan, count], idx) => {
		const card = document.createElement("div");
		card.className = "stat-card";
		const c = colors[idx % colors.length];
		card.style.background = c.bg;

		// header with title and small spacer
		const header = document.createElement("div");
		header.className = "stat-header";

		const titleWrap = document.createElement("div");
		titleWrap.style.display = "flex";
		titleWrap.style.flexDirection = "column";

		const title = document.createElement("div");
		title.className = "stat-title";
		title.textContent = pelabuhan;

		// PKK Manual: count of rows with empty no_pkk_inaportnet for this pelabuhan
		const manualCount = manualCounts[pelabuhan] || 0;
		// calculate percentage (safe divide)
		let pct = 0;
		if (count > 0) pct = (manualCount / count) * 100;
		// format: integer if whole, otherwise 1 decimal
		const pctText = (Math.abs(pct - Math.round(pct)) < 0.05) ? Math.round(pct).toString() : pct.toFixed(1);
		const manualLabel = document.createElement("div");
		manualLabel.className = "pkk-manual";
		manualLabel.textContent = `PKK Manual: ${manualCount} (${pctText}%)`;

		titleWrap.appendChild(title);
		titleWrap.appendChild(manualLabel);

		// place value separately to allow right alignment and adjusted size
		const value = document.createElement("div");
		value.className = "stat-value";
		value.textContent = count;

		header.appendChild(titleWrap);
		// spacer to push value to right
		const spacer = document.createElement("div");
		spacer.style.flex = "1 1 auto";
		header.appendChild(spacer);

		card.appendChild(header);
		card.appendChild(value);

		// decorative circle
		const circle = document.createElement("div");
		circle.className = "card-circle";
		circle.style.background = c.circle;
		card.appendChild(circle);

		rowDiv.appendChild(card);
	});
}

        async function main() {
            const csvText = await fetchCSV("gabung.csv");
            if (!csvText) return;
            const { headers, data: rawData } = parseCSV(csvText);

            // Try to fetch abai.csv and build a set of PKK values to ignore
            let abaiSet = new Set();
            try {
                const abaiText = await fetchCSV("abai.csv");
                if (abaiText) {
                    const lines = abaiText.split("\n").map(l => l.trim()).filter(Boolean);
                    if (lines.length) {
                        // Remove header line if it contains header name
                        if (/no_pkk_inaportnet/i.test(lines[0])) lines.shift();
                        lines.forEach(line => {
                            // support values separated by commas and extra commas/empty items
                            line.split(",").forEach(v => {
                                const t = (v || "").trim();
                                if (t) abaiSet.add(t);
                            });
                        });
                    }
                }
            } catch (e) {
                console.warn("Could not load abai.csv â€” proceeding without exclusions.", e);
            }

            // Filter out rows whose no_pkk_inaportnet appears in abaiSet
            const filtered = rawData.filter(r => {
                const key = (r["no_pkk_inaportnet"] || "").trim();
                return !key || !abaiSet.has(key);
            });
            const removedCount = rawData.length - filtered.length;
            if (removedCount > 0) console.info(`Excluded ${removedCount} rows based on abai.csv`);

            globalHeaders = headers;
            globalData = filtered;

            renderPelabuhanCards(filtered);
            populateTable(headers, filtered);
            populatePelabuhanFilter(filtered);
            populateYearFilter(filtered);
            attachPelabuhanFilterListener();
            attachYearFilterListener();

            const { labels, values } = aggregateByMonth(filtered);
            const ctx = document.getElementById("barChart").getContext("2d");
            barChart = buildBarChart(ctx, labels, values);
         }

        // New: download gabung.csv by fetching as blob then triggering a download
        async function downloadGabung() {
            const btn = document.getElementById("downloadGabungBtn");
            if (btn) btn.disabled = true;
            try {
                // Try XLSX first
                try {
                    const resp = await fetch("gabung.xlsx", { cache: "no-store" });
                    if (!resp.ok) throw new Error("gabung.xlsx not available");
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "gabung.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1500);
                    return;
                } catch (errX) {
                    console.warn("gabung.xlsx not found, falling back to gabung.csv:", errX);
                }

                // Fallback to CSV
                const respCsv = await fetch("gabung.csv", { cache: "no-store" });
                if (!respCsv.ok) throw new Error("gabung.csv not available");
                const blobCsv = await respCsv.blob();
                const urlCsv = URL.createObjectURL(blobCsv);
                const aCsv = document.createElement("a");
                aCsv.href = urlCsv;
                aCsv.download = "gabung.csv";
                document.body.appendChild(aCsv);
                aCsv.click();
                aCsv.remove();
                setTimeout(() => URL.revokeObjectURL(urlCsv), 1500);
            } catch (err) {
                console.error("Download gabung failed:", err);
                alert("Gagal mendownload gabung.xlsx atau gabung.csv. Periksa file dan hak akses server.");
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        main();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>
  // Enforce session + 30-minute inactivity logout
  if (typeof enforceAuth === 'function') {
    enforceAuth();
  }
</script>
</body>
</html>
